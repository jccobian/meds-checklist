<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendario de medicamentos</title>

  <link rel="icon" type="image/x-icon" href="./logo.ico" />

  <style>
    :root{
      --bg0:#07080b;
      --bg1:#0b0c10;
      --bg2:#0d0f16;

      --text:#f3f4f7;
      --muted:#b2b6c2;

      --gold:#d6b35a;
      --gold2:#f1d38b;

      --line: rgba(255,255,255,0.10);
      --line2: rgba(255,255,255,0.08);

      --shadow: 0 10px 26px rgba(0,0,0,0.40);
      --r:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(214,179,90,0.15), transparent 58%),
        radial-gradient(900px 520px at 100% 10%, rgba(214,179,90,0.10), transparent 62%),
        radial-gradient(1100px 700px at 60% 120%, rgba(241,211,139,0.08), transparent 65%),
        linear-gradient(180deg, var(--bg0), var(--bg2));
      padding: 22px;
      overflow-x:hidden;
      display:flex;
      justify-content:center;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background: url("./logo.png") center 22% / 520px auto no-repeat;
      opacity: 0.035;
      filter: saturate(1.1) contrast(1.05);
      transform: translateZ(0);
    }

    body::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
      opacity: .05;
      mix-blend-mode: overlay;
    }

    .page{
      width:100%;
      max-width: 980px;
      display:flex;
      flex-direction:column;
      min-height: calc(100vh - 44px);
      gap: 16px;
      position:relative;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 16px 16px;
      border-radius: var(--r);
      border: 1px solid var(--line2);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 280px;
    }
    .brand img{
      width: 64px;
      height: 64px;
      border-radius: 14px;
      object-fit: contain;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(214,179,90,0.28);
      box-shadow: 0 12px 22px rgba(0,0,0,0.35);
      padding: 6px;
    }
    .brand .t{display:flex; flex-direction:column; gap:6px;}
    .brand h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .25px;
      font-weight: 820;
      line-height: 1.1;
    }
    .pill{
      width: fit-content;
      font-size: 13px;
      color: var(--muted);
      padding: 7px 11px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.25);
    }

    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      width:100%;
    }

    button{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.24);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: .16s ease;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
      font-weight: 700;
    }
    button:hover{
      transform: translateY(-1px);
      background: rgba(0,0,0,0.32);
      border-color: rgba(214,179,90,0.28);
      box-shadow: 0 10px 20px rgba(0,0,0,0.32);
    }
    button:active{ transform: translateY(0px); box-shadow:none; }

    .btn-gold{
      border-color: rgba(214,179,90,0.36);
      background: linear-gradient(180deg, rgba(214,179,90,0.22), rgba(0,0,0,0.18));
    }
    .btn-danger{
      border-color: rgba(255,77,109,0.35);
      background: linear-gradient(180deg, rgba(255,77,109,0.16), rgba(0,0,0,0.18));
    }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
      align-items:start;
      flex: 1 1 auto;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns: 1fr;}
    }

    .card{
      border: 1px solid var(--line2);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }

    .card-head{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.12);
    }
    .card-head h2{
      margin:0;
      font-size: 15px;
      letter-spacing: .2px;
      display:flex;
      gap:10px;
      align-items:center;
      font-weight: 860;
    }
    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--muted);
      background: rgba(0,0,0,0.20);
    }
    .badge.gold{
      border-color: rgba(214,179,90,0.30);
      color: rgba(241,211,139,0.95);
      background: rgba(214,179,90,0.10);
    }

    .section{
      padding: 12px 12px 6px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .subhead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      background: rgba(0,0,0,0.18);
    }
    .subhead .left{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .subhead .right{
      color: var(--muted);
      font-size: 12px;
      text-align:right;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding-bottom: 8px;
    }

    .item{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding: 14px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      transition: transform .14s ease, box-shadow .14s ease, border-color .14s ease, opacity .14s ease;
      position:relative;
      overflow:hidden;
      isolation:isolate;
      cursor:pointer;
    }
    .item:hover{
      border-color: rgba(214,179,90,0.22);
      transform: translateY(-1px);
      box-shadow: 0 12px 22px rgba(0,0,0,0.30);
    }

    .item::after{
      content:"";
      position:absolute;
      left: var(--sx, 50%);
      top: var(--sy, 50%);
      width: 12px;
      height: 12px;
      transform: translate(-50%, -50%) scale(0);
      border-radius: 999px;
      pointer-events:none;
      opacity: 0;
      background:
        radial-gradient(circle,
          rgba(241,211,139,0.85) 0%,
          rgba(214,179,90,0.55) 25%,
          rgba(214,179,90,0.20) 45%,
          transparent 65%);
      z-index: 0;
    }
    .item.spark::after{ animation: sparkBurst 650ms ease-out forwards; }
    @keyframes sparkBurst{
      0%   { opacity: 0; transform: translate(-50%, -50%) scale(0.25); }
      15%  { opacity: 1; transform: translate(-50%, -50%) scale(2.4); }
      55%  { opacity: 0.9; transform: translate(-50%, -50%) scale(7.6); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(10.5); }
    }
    .sparkle{
      position:absolute;
      left: 0; top: 0;
      width: 6px; height: 6px;
      border-radius: 999px;
      pointer-events:none;
      background: radial-gradient(circle, rgba(241,211,139,.95), rgba(214,179,90,.4), transparent 70%);
      filter: drop-shadow(0 0 8px rgba(214,179,90,.25));
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.6);
      animation: sparkleFly 650ms ease-out forwards;
      z-index: 1;
    }
    @keyframes sparkleFly{
      0%   { opacity: 0; transform: translate(var(--x0), var(--y0)) scale(0.6); }
      15%  { opacity: 1; }
      100% { opacity: 0; transform: translate(var(--x1), var(--y1)) scale(0.2); }
    }

    .item.done{
      opacity: .82;
      border-color: rgba(214,179,90,0.26);
    }
    .item.done::before{
      content:"";
      position:absolute;
      inset:-40px;
      background: radial-gradient(520px 170px at 10% 10%, rgba(214,179,90,0.10), transparent 60%);
      pointer-events:none;
      z-index:0;
    }

    .check{
      flex:0 0 auto;
      width: 28px;
      height: 28px;
      margin-top: 2px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(0,0,0,0.20);
      display:grid;
      place-items:center;
      z-index: 2;
    }
    .item.done .check{
      border-color: rgba(214,179,90,0.55);
      background: rgba(214,179,90,0.14);
      box-shadow: 0 0 0 4px rgba(214,179,90,0.12);
    }
    .check svg{
      width: 16px; height: 16px;
      opacity: 0;
      transform: scale(.85);
      transition: .16s ease;
    }
    .item.done .check svg{
      opacity: 1;
      transform: scale(1);
    }

    .content{
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
      z-index: 2;
    }
    .name{
      margin:0;
      font-weight: 900;
      font-size: 16px;
      line-height: 1.22;
      word-break: break-word;
    }
    .meta{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .tagline{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 2px;
    }
    .tag{
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      color: var(--muted);
      font-weight: 800;
    }
    .tag.gold{
      border-color: rgba(214,179,90,0.30);
      color: rgba(241,211,139,0.95);
      background: rgba(214,179,90,0.10);
    }

    .side{
      display:flex;
      flex-direction:column;
      gap:16px;
      position:sticky;
      top:16px;
    }
    @media (max-width: 900px){ .side{ position:static; } }

    .stats{ padding: 16px; display:flex; flex-direction:column; gap:12px; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; font-size: 13px; color: var(--muted); }
    .row strong{ color: var(--text); }

    .bar{
      width:100%;
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.10);
    }
    .bar > div{
      height:100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(214,179,90,0.95), rgba(241,211,139,0.95));
      transition: width .22s ease;
      box-shadow: 0 0 18px rgba(214,179,90,0.22);
    }

    .tip{
      padding: 14px 16px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
      border-top: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
    }

    .week{
      display:grid;
      grid-template-columns: 1.1fr repeat(7, 1fr);
      gap:10px;
      padding: 12px;
    }
    .week .th{
      font-weight: 900;
      color: rgba(241,211,139,0.95);
      font-size: 13px;
      letter-spacing: .2px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(214,179,90,0.18);
      background: rgba(0,0,0,0.18);
      text-align:center;
    }
    .week .th.left{ text-align:left; color: var(--text); border-color: rgba(255,255,255,0.12); }
    .cell{
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
      min-height: 44px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .cell.left{
      justify-content:flex-start;
      color: var(--text);
      font-weight: 900;
    }
    .cell button{
      width: 100%;
      justify-content:center;
      padding: 10px 10px;
      border-radius: 12px;
    }

    footer{
      margin-top: 4px;
      padding: 14px 10px 6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: rgba(178,182,194,0.92);
      font-size: 12px;
      border-top: 1px solid rgba(255,255,255,0.10);
      text-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
    footer .right{ display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
    .sep{ width:6px;height:6px;border-radius:999px; background: rgba(214,179,90,0.65); box-shadow: 0 0 0 4px rgba(214,179,90,0.10); }
    .gold{ color: rgba(241,211,139,0.95); }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.60);
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 999px;
      padding: 10px 14px;
      box-shadow: 0 18px 44px rgba(0,0,0,0.55);
      opacity: 0;
      pointer-events:none;
      transition: .18s ease;
      display:flex;
      align-items:center;
      gap:10px;
      max-width: calc(100% - 24px);
      backdrop-filter: blur(10px);
      z-index: 9999;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-6px); }
    .toast .dot{ width: 10px; height: 10px; border-radius: 999px; background: var(--gold); box-shadow: 0 0 0 4px rgba(214,179,90,0.14); }
    .toast .tmsg{ font-size: 13px; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; color: var(--text); }

    @media (max-width: 600px){
      body{
        padding: 14px;
        background: #0b0c10 !important;
      }
      body::before, body::after{ display:none !important; }

      header{
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 16px;
      }

      .brand{
        min-width: 0;
        width: 100%;
      }
      .brand img{
        width: 56px;
        height: 56px;
        border-radius: 14px;
      }
      .brand h1{
        font-size: 22px !important;
        line-height: 1.15;
      }
      .pill{
        font-size: 14px;
        padding: 8px 14px;
      }

      .controls{
        justify-content: stretch;
      }
      .controls button{
        flex: 1 1 calc(50% - 6px);
        justify-content:center;
        padding: 12px 12px;
        border-radius: 16px;
        font-size: 15px;
      }

      .card{
        background: #111217 !important;
        box-shadow: none !important;
        backdrop-filter: none !important;
      }

      .card-head h2{ font-size: 18px !important; }

      .subhead .left{ font-size: 17px; }
      .subhead .right{ font-size: 13px; }

      .item{
        padding: 18px 16px;
        border-radius: 18px;
        gap: 14px;
      }
      .check{
        width: 32px;
        height: 32px;
        border-radius: 12px;
      }
      .name{
        font-size: 18px !important;
        line-height: 1.25;
      }
      .meta{
        font-size: 14px !important;
        line-height: 1.45;
      }

      .week{
        grid-template-columns: 1fr;
      }
      .week .th{ display:none; }
      .week .cell.left{
        justify-content:center;
        font-size: 16px;
      }
      .cell{
        min-height: 52px;
      }

      footer{
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 8px;
        padding-bottom: 12px;
        font-size: 14px;
      }
    }

    @media print{
      body{
        background: #fff !important;
        color: #000 !important;
        padding: 0 !important;
      }

      body::before, body::after{ display:none !important; }

      header, footer, .controls, .tip, .toast, .side{ display:none !important; }

      .page{
        max-width: none !important;
        min-height: auto !important;
        gap: 10px !important;
      }

      .grid{
        display:block !important;
      }

      .card{
        border: none !important;
        box-shadow: none !important;
        background: #fff !important;
      }

      .card-head{
        background: #fff !important;
        border: none !important;
        padding: 8px 0 6px !important;
      }
      .card-head h2{
        font-size: 18px !important;
        color: #000 !important;
      }
      .badge{ display:none !important; }

      .subhead{
        border: 1px solid #000 !important;
        background: #fff !important;
      }
      .subhead .right{ color:#333 !important; }

      .item{
        border: 1px solid #000 !important;
        border-radius: 6px !important;
        background: #fff !important;
        box-shadow: none !important;
        padding: 12px 10px !important;
        page-break-inside: avoid;
      }

      .check{
        border: 2px solid #000 !important;
        background: #fff !important;
        box-shadow: none !important;
      }
      .item.done .check svg{ opacity: 1 !important; }

      .name{ color:#000 !important; font-size: 16px !important; }
      .meta{ color:#333 !important; font-size: 12px !important; }

      .week{
        grid-template-columns: 1.2fr repeat(7, 1fr) !important;
      }
      .week .th{
        display:flex !important;
        color:#000 !important;
        background:#fff !important;
        border: 1px solid #000 !important;
      }
      .cell{
        border: 1px solid #000 !important;
        background:#fff !important;
      }

      @page { size: Letter; margin: 0.6in; }
    }
  </style>
</head>

<body>
  <div class="page">
    <header>
      <div class="brand">
        <img src="./logo.png" alt="Cobian PC" />
        <div class="t">
          <h1>Calendario de medicamentos</h1>
          <div class="pill">Impresi√≥n Carta ‚Ä¢ Marca dosis (checkbox) ‚Ä¢ Se guarda autom√°ticamente</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn-gold" id="btnPrint">üñ®Ô∏è Imprimir</button>
        <button class="btn-gold" id="btnMarkToday">‚úÖ Marcar rutina del d√≠a</button>
        <button class="btn-danger" id="btnClear">üßº Limpiar todo</button>
      </div>
    </header>

    <div class="grid">
      <main class="card">
        <div class="card-head">
          <h2>üïí Rutina diaria <span class="badge gold" id="countDaily">0/0</span></h2>
          <span class="badge">Ma√±ana ‚Ä¢ Tarde ‚Ä¢ Noche</span>
        </div>

        <div class="section">
          <div class="subhead">
            <div class="left">üå§Ô∏è Ma√±ana</div>
            <div class="right">Despu√©s / seg√∫n indique</div>
          </div>
          <div class="list" id="listMorning"></div>

          <div class="subhead">
            <div class="left">üåá Tarde</div>
            <div class="right">Horario recomendado</div>
          </div>
          <div class="list" id="listAfternoon"></div>

          <div class="subhead">
            <div class="left">üåô Noche</div>
            <div class="right">Despu√©s de cenar</div>
          </div>
          <div class="list" id="listNight"></div>
        </div>

        <div class="card-head">
          <h2>üìÖ Calendario semanal <span class="badge gold" id="countWeekly">0/0</span></h2>
          <span class="badge">Marcar dosis especiales</span>
        </div>

        <div class="section" style="padding-top:10px;">
          <div class="tagline" style="padding: 0 2px 6px;">
            <span class="tag gold">Recomendado: Eritropoyetina (L-M-V)</span>
            <span class="tag">Ertapenem IV diario (seg√∫n receta)</span>
          </div>

          <div class="week" id="weekGrid"></div>
        </div>

        <div class="tip">
          Tip: toca el rengl√≥n para marcar. Al marcar aparece ‚Äúmagia dorada‚Äù ‚ú®
        </div>
      </main>

      <aside class="side">
        <section class="card">
          <div class="card-head">
            <h2>üìä Progreso <span class="badge gold" id="countAll">0/0</span></h2>
            <span class="badge gold" id="percent">0%</span>
          </div>

          <div class="stats">
            <div class="row"><span>Marcados</span><strong id="doneText">0</strong></div>
            <div class="bar"><div id="barFill"></div></div>
            <div class="row"><span>Pendientes</span><strong id="leftText">0</strong></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button id="btnCopyRemaining" title="Copia pendientes al portapapeles">üìã Copiar pendientes</button>
              <button id="btnCopyAll" title="Copia todo al portapapeles">üìã Copiar todo</button>
            </div>
          </div>

          <div class="tip" style="border-top:1px solid rgba(255,255,255,0.10);">
            Nota: esto es un organizador. Si el m√©dico ajusta dosis/horarios, se actualiza aqu√≠.
          </div>
        </section>
      </aside>
    </div>

    <footer>
      <div>¬© <span id="year"></span> <span class="gold">Derechos reservados</span></div>
      <div class="right">
        <span class="sep"></span>
        <div>Powered by <strong class="gold">Cobian PC</strong></div>
      </div>
    </footer>
  </div>

  <div class="toast" id="toast">
    <span class="dot"></span>
    <span class="tmsg" id="toastMsg">Guardado</span>
  </div>

  <script>
    // =========================
    // DATOS (aj√∫stalos si cambia la receta)
    // =========================
    const DATA = {
      daily: {
        morning: [
          { id:"amiodarona_am", name:"Amiodarona (¬Ω tableta)", meta:"Ma√±ana" },
          { id:"rivaroxaban_am", name:"Rivaroxaban 15 mg (¬Ω tableta)", meta:"Ma√±ana" },
          { id:"acido_folico_am", name:"√Åcido f√≥lico", meta:"Ma√±ana" },
          { id:"zyplo_am_8h", name:"Zyplo 10 ml (cada 8 hrs)", meta:"Ma√±ana (dosis 1)" },
          { id:"linezolid_am", name:"Linezolid 600 mg (1 tableta)", meta:"Cada 12 hrs ‚Ä¢ despu√©s de comer" }
        ],
        afternoon: [
          { id:"omeprazol_pm", name:"Omeprazol", meta:"Tarde" },
          { id:"ziplo_5pm", name:"Ziplo 10 ml", meta:"5:00 pm" },
          { id:"inhalador_6pm", name:"Inhalador", meta:"6:00 pm" }
        ],
        night: [
          { id:"insulina_noc", name:"Insulina", meta:"Noche" },
          { id:"sulfato_ferroso_noc", name:"Sulfato ferroso", meta:"Noche" },
          { id:"zyplo_noc_8h", name:"Zyplo 10 ml (cada 8 hrs)", meta:"Noche (dosis 3)" },
          { id:"linezolid_noc", name:"Linezolid 600 mg (1 tableta)", meta:"Despu√©s de cenar" },
          { id:"ertapenem_iv_noc", name:"Ertapenem IV", meta:"1 vez al d√≠a (seg√∫n receta)" }
        ]
      },
      weekly: [
        { key:"epo",  label:"Eritropoyetina (L-M-V)", days:{ Mon:true, Wed:true, Fri:true } },
        { key:"erta", label:"Ertapenem IV (diario)",  days:{ Mon:true, Tue:true, Wed:true, Thu:true, Fri:true, Sat:true, Sun:true } }
      ]
    };

    // =========================
    // STORAGE
    // =========================
    const STORAGE_KEY = "cobian_meds_calendar_v2"; // v2 para no romper tu storage anterior
    const state = loadState();

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : { checked: {}, lastDailyDate: null };
      }catch(_){
        return { checked: {}, lastDailyDate: null };
      }
    }

    function saveState(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        toast("Guardado ‚úÖ");
      }catch(e){
        console.warn("No se pudo guardar en localStorage:", e);
        toast("No se pudo guardar ‚ö†Ô∏è");
      }
    }

    // =========================
    // REINICIO DIARIO (rutina)
    // =========================
    const DAILY_IDS = [
      ...DATA.daily.morning.map(x=>x.id),
      ...DATA.daily.afternoon.map(x=>x.id),
      ...DATA.daily.night.map(x=>x.id),
    ];

    function ymdLocal(d = new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function ensureDailyDate(){
      const today = ymdLocal();
      if(!state.lastDailyDate){
        state.lastDailyDate = today;
        saveState();
        return;
      }
      if(state.lastDailyDate !== today){
        DAILY_IDS.forEach(id => { delete state.checked[id]; });
        state.lastDailyDate = today;
        saveState();
        toast("Nuevo d√≠a: rutina reiniciada ‚òÄÔ∏è");
      }
    }

    // =========================
    // REINICIO SEMANAL (cada lunes)
    // =========================
    function getISOWeekKey(date = new Date()){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7; // domingo=7
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      const week = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return `${d.getUTCFullYear()}-W${String(week).padStart(2, "0")}`;
    }

    // =========================
    // HELPERS UI
    // =========================
    const elMorning = document.getElementById("listMorning");
    const elAfternoon = document.getElementById("listAfternoon");
    const elNight = document.getElementById("listNight");
    const elWeek = document.getElementById("weekGrid");

    const countDaily = document.getElementById("countDaily");
    const countWeekly = document.getElementById("countWeekly");
    const countAll = document.getElementById("countAll");
    const percent = document.getElementById("percent");
    const barFill = document.getElementById("barFill");
    const doneText = document.getElementById("doneText");
    const leftText = document.getElementById("leftText");

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function itemHtml(item, checked){
      return `
        <div class="check" role="checkbox" aria-checked="${checked}" tabindex="0" title="Marcar / desmarcar">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M20 6L9 17l-5-5" stroke="rgba(243,244,247,.95)" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="content">
          <p class="name">${escapeHtml(item.name)}</p>
          <p class="meta">${escapeHtml(item.meta || "")}</p>
        </div>
      `;
    }

    function renderList(items, mount){
      mount.innerHTML = "";
      items.forEach(item => {
        const checked = !!state.checked[item.id];
        const el = document.createElement("div");
        el.className = "item" + (checked ? " done" : "");
        el.dataset.id = item.id;
        el.innerHTML = itemHtml(item, checked);

        el.setAttribute("role","button");
        el.setAttribute("aria-pressed", checked ? "true" : "false");
        el.setAttribute("tabindex","0");

        el.addEventListener("click", (ev) => {
          if (window.getSelection && String(window.getSelection()).length > 0) return;
          const was = !!state.checked[item.id];
          toggle(item.id);
          if(!was) magicSpark(el, ev);
        });

        el.addEventListener("keydown", (ev) => {
          if(ev.key === "Enter" || ev.key === " "){
            ev.preventDefault();
            const was = !!state.checked[item.id];
            toggle(item.id);
            if(!was) magicSpark(el, null);
          }
        });

        mount.appendChild(el);
      });
    }

    function renderWeek(){
      const weekKey = getISOWeekKey(); // <-- CLAVE: cambia cada lunes

      const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
      const dayLabels = { Mon:"Lunes", Tue:"Martes", Wed:"Mi√©rcoles", Thu:"Jueves", Fri:"Viernes", Sat:"S√°bado", Sun:"Domingo" };

      elWeek.innerHTML = "";

      const thLeft = document.createElement("div");
      thLeft.className = "th left";
      thLeft.textContent = "Bloque";
      elWeek.appendChild(thLeft);

      days.forEach(d=>{
        const th = document.createElement("div");
        th.className = "th";
        th.textContent = dayLabels[d];
        elWeek.appendChild(th);
      });

      DATA.weekly.forEach(row=>{
        const left = document.createElement("div");
        left.className = "cell left";
        left.textContent = row.label;
        elWeek.appendChild(left);

        days.forEach(d=>{
          const cell = document.createElement("div");
          cell.className = "cell";
          const enabled = !!row.days[d];

          if(!enabled){
            cell.style.opacity = ".35";
            cell.textContent = "‚Äî";
            elWeek.appendChild(cell);
            return;
          }

          const id = `wk_${weekKey}_${row.key}_${d}`; // <-- CLAVE: incluye semana
          const checked = !!state.checked[id];

          const btn = document.createElement("button");
          btn.className = checked ? "btn-gold" : "";
          btn.textContent = checked ? "‚úÖ Hecho" : "‚òê Pendiente";

          btn.addEventListener("click", (ev)=>{
            const was = !!state.checked[id];
            toggle(id, {silentRender:true});
            if(!was) magicSparkCell(cell, ev);
            render();
          });

          cell.appendChild(btn);
          elWeek.appendChild(cell);
        });
      });
    }

    function toggle(id, {silentRender} = {}){
      state.checked[id] = !state.checked[id];
      saveState();
      if(!silentRender) render();
    }

    function render(){
      renderList(DATA.daily.morning, elMorning);
      renderList(DATA.daily.afternoon, elAfternoon);
      renderList(DATA.daily.night, elNight);
      renderWeek();
      updateStats();
    }

    function updateStats(){
      const weekKey = getISOWeekKey(); // <-- stats solo de la semana actual

      const dailyAll = [...DATA.daily.morning, ...DATA.daily.afternoon, ...DATA.daily.night];
      const weeklyAll = [];
      const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

      DATA.weekly.forEach(r=>{
        days.forEach(d=>{
          if(r.days[d]) weeklyAll.push({ id:`wk_${weekKey}_${r.key}_${d}` });
        });
      });

      const totalDaily = dailyAll.length;
      const totalWeekly = weeklyAll.length;
      const total = totalDaily + totalWeekly;

      const doneDaily = dailyAll.filter(x => !!state.checked[x.id]).length;
      const doneWeekly = weeklyAll.filter(x => !!state.checked[x.id]).length;
      const done = doneDaily + doneWeekly;

      countDaily.textContent = `${doneDaily}/${totalDaily}`;
      countWeekly.textContent = `${doneWeekly}/${totalWeekly}`;
      countAll.textContent = `${done}/${total}`;

      const p = total ? Math.round((done/total)*100) : 0;
      percent.textContent = `${p}%`;
      barFill.style.width = `${p}%`;

      doneText.textContent = String(done);
      leftText.textContent = String(total - done);
    }

    function magicSpark(el, ev){
      const rect = el.getBoundingClientRect();
      let x = rect.width * 0.22;
      let y = rect.height * 0.40;

      if (ev && typeof ev.clientX === "number"){
        x = ev.clientX - rect.left;
        y = ev.clientY - rect.top;
      }

      el.style.setProperty("--sx", x + "px");
      el.style.setProperty("--sy", y + "px");

      el.classList.remove("spark");
      void el.offsetWidth;
      el.classList.add("spark");

      const N = 10;
      for(let i=0;i<N;i++){
        const p = document.createElement("span");
        p.className = "sparkle";

        const ang = (Math.PI * 2) * (i / N) + (Math.random() * 0.35);
        const dist = 30 + Math.random() * 55;

        p.style.setProperty("--x0", `${x}px`);
        p.style.setProperty("--y0", `${y}px`);
        p.style.setProperty("--x1", `${x + Math.cos(ang)*dist}px`);
        p.style.setProperty("--y1", `${y + Math.sin(ang)*dist}px`);

        const size = 4 + Math.random()*5;
        p.style.width = size + "px";
        p.style.height = size + "px";

        el.appendChild(p);
        setTimeout(() => p.remove(), 750);
      }

      setTimeout(() => el.classList.remove("spark"), 750);
    }

    function magicSparkCell(cell, ev){
      const rect = cell.getBoundingClientRect();
      const x = (ev && ev.clientX) ? ev.clientX - rect.left : rect.width/2;
      const y = (ev && ev.clientY) ? ev.clientY - rect.top : rect.height/2;

      const N = 10;
      for(let i=0;i<N;i++){
        const p = document.createElement("span");
        p.className = "sparkle";

        const ang = (Math.PI * 2) * (i / N) + (Math.random() * 0.35);
        const dist = 24 + Math.random() * 45;

        p.style.setProperty("--x0", `${x}px`);
        p.style.setProperty("--y0", `${y}px`);
        p.style.setProperty("--x1", `${x + Math.cos(ang)*dist}px`);
        p.style.setProperty("--y1", `${y + Math.sin(ang)*dist}px`);

        const size = 4 + Math.random()*5;
        p.style.width = size + "px";
        p.style.height = size + "px";

        cell.style.position = "relative";
        cell.style.overflow = "hidden";
        cell.appendChild(p);
        setTimeout(() => p.remove(), 750);
      }
    }

    // =========================
    // Acciones
    // =========================
    document.getElementById("btnPrint").addEventListener("click", () => {
      window.print();
    });

    document.getElementById("btnClear").addEventListener("click", () => {
      if(!confirm("¬øSeguro que quieres limpiar TODO (rutina + semanal)?")) return;
      state.checked = {};
      state.lastDailyDate = ymdLocal();
      saveState();
      render();
      toast("Limpio üßº");
    });

    document.getElementById("btnMarkToday").addEventListener("click", () => {
      const dailyAll = [...DATA.daily.morning, ...DATA.daily.afternoon, ...DATA.daily.night];
      let changed = 0;

      dailyAll.forEach(x => {
        if(!state.checked[x.id]){
          state.checked[x.id] = true;
          changed++;
        }
      });

      saveState();
      render();
      toast(changed ? `Rutina marcada ‚úÖ (+${changed})` : "Todo ya estaba marcado ‚úÖ");
    });

    document.getElementById("btnCopyAll").addEventListener("click", async () => {
      const text = buildText({ onlyRemaining:false });
      await copyToClipboard(text);
      toast("Copiado üìã");
    });

    document.getElementById("btnCopyRemaining").addEventListener("click", async () => {
      const text = buildText({ onlyRemaining:true });
      await copyToClipboard(text);
      toast("Pendientes copiados üìã");
    });

    function buildText({ onlyRemaining }){
      const weekKey = getISOWeekKey();

      const lines = [];
      const pushSection = (title, arr) => {
        const list = onlyRemaining ? arr.filter(x => !state.checked[x.id]) : arr;
        if(list.length === 0) return;
        lines.push(title);
        list.forEach(x => lines.push(`- ${x.name} (${x.meta || ""})`.trim()));
        lines.push("");
      };

      pushSection("MA√ëANA", DATA.daily.morning);
      pushSection("TARDE", DATA.daily.afternoon);
      pushSection("NOCHE", DATA.daily.night);

      const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
      const dayLabels = { Mon:"Lunes", Tue:"Martes", Wed:"Mi√©rcoles", Thu:"Jueves", Fri:"Viernes", Sat:"S√°bado", Sun:"Domingo" };

      lines.push(`SEMANAL (${weekKey})`);
      DATA.weekly.forEach(r=>{
        days.forEach(d=>{
          if(!r.days[d]) return;
          const id = `wk_${weekKey}_${r.key}_${d}`;
          const done = !!state.checked[id];
          if(onlyRemaining && done) return;
          lines.push(`- ${r.label} ‚Ä¢ ${dayLabels[d]} ‚Ä¢ ${done ? "Hecho" : "Pendiente"}`);
        });
      });

      return lines.join("\n").trim();
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
      }catch(_){
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
      }
    }

    // =========================
    // Toast
    // =========================
    const toastEl = document.getElementById("toast");
    const toastMsg = document.getElementById("toastMsg");
    let toastTimer = null;

    function toast(msg){
      toastMsg.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.remove("show"), 1600);
    }

    document.getElementById("year").textContent = new Date().getFullYear();

    // 1) Asegura reinicio diario antes de pintar
    ensureDailyDate();

    // 2) Render inicial
    render();
  </script>
</body>
</html>
