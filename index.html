<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendario de Medicamentos (Impresi√≥n Carta)</title>
  <link rel="icon" type="image/x-icon" href="./logo.ico" />

  <style>
    :root{
      --bg0:#07080b;
      --bg2:#0d0f16;
      --text:#f3f4f7;
      --muted:#c7cad3;
      --gold:#d6b35a;
      --gold2:#f1d38b;
      --line: rgba(255,255,255,0.10);
      --shadow2: 0 14px 34px rgba(0,0,0,0.45);
      --r:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(214,179,90,0.14), transparent 58%),
        radial-gradient(900px 520px at 100% 10%, rgba(214,179,90,0.10), transparent 62%),
        radial-gradient(1100px 700px at 60% 120%, rgba(241,211,139,0.08), transparent 65%),
        linear-gradient(180deg, var(--bg0), var(--bg2));
      padding: 22px;
      overflow-x:hidden;
      display:flex;
      justify-content:center;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background: url("./logo.png") center 22% / 540px auto no-repeat;
      opacity: 0.035;
      filter: saturate(1.1) contrast(1.05);
      transform: translateZ(0);
    }

    body::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
      opacity: .05;
      mix-blend-mode: overlay;
    }

    .page{
      width:100%;
      max-width: 1020px;
      display:flex;
      flex-direction:column;
      gap: 16px;
      position:relative;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 16px 16px;
      border-radius: var(--r);
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
      box-shadow: var(--shadow2);
      backdrop-filter: blur(12px);
      min-width: 0;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 280px;
    }
    .brand img{
      width: 68px;
      height: 68px;
      border-radius: 14px;
      object-fit: contain;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(214,179,90,0.28);
      box-shadow: 0 12px 22px rgba(0,0,0,0.35);
      padding: 6px;
      flex: 0 0 auto;
    }
    .brand .t{display:flex; flex-direction:column; gap:6px; min-width:0;}
    .brand h1{
      margin:0;
      font-size: 20px;
      letter-spacing: .2px;
      font-weight: 820;
      line-height: 1.1;
      word-break: break-word;
    }
    .pill{
      width: fit-content;
      font-size: 14px;
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.25);
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      min-width: 0;
    }

    button{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      cursor:pointer;
      transition: .16s ease;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
      font-size: 14px;
      font-weight: 750;
    }
    button:hover{
      transform: translateY(-1px);
      background: rgba(0,0,0,0.30);
      border-color: rgba(214,179,90,0.28);
      box-shadow: 0 10px 20px rgba(0,0,0,0.32);
    }
    button:active{ transform: translateY(0px); box-shadow:none; }

    .btn-gold{
      border-color: rgba(214,179,90,0.36);
      background: linear-gradient(180deg, rgba(214,179,90,0.22), rgba(0,0,0,0.18));
    }
    .btn-danger{
      border-color: rgba(255,77,109,0.35);
      background: linear-gradient(180deg, rgba(255,77,109,0.16), rgba(0,0,0,0.18));
    }

    .card{
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }

    .card-head{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
      min-width: 0;
    }
    .card-head h2{
      margin:0;
      font-size: 16px;
      letter-spacing: .25px;
      display:flex;
      gap:10px;
      align-items:center;
      font-weight: 850;
      min-width: 0;
    }
    .badge{
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--muted);
      background: rgba(0,0,0,0.20);
      white-space:nowrap;
    }
    .badge.gold{
      border-color: rgba(214,179,90,0.32);
      color: rgba(241,211,139,0.95);
      background: rgba(214,179,90,0.10);
    }

    /* ===== RUTINA ===== */
    .routine{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 14px;
    }
    @media (max-width: 860px){
      .routine{ grid-template-columns: 1fr; }
    }

    .block{
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      background: rgba(0,0,0,0.16);
      overflow:hidden;
    }
    .block .bh{
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
      gap: 10px;
      min-width:0;
    }
    .block .bh strong{
      font-size: 16px;
      letter-spacing: .2px;
    }
    .block .bh span{
      font-size: 13px;
      color: var(--muted);
      text-align:right;
      min-width:0;
    }
    .block .bl{
      padding: 10px 12px 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .dose{
      display:flex;
      align-items:flex-start;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
    }
    .dose input[type="checkbox"]{
      width: 22px;
      height: 22px;
      accent-color: var(--gold);
      margin-top: 2px;
      flex: 0 0 auto;
      cursor:pointer;
    }

    .dose .txt{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width:0;
    }
    .dose .name{
      margin:0;
      font-size: 16px;
      font-weight: 850;
      line-height: 1.15;
      word-break: break-word;
    }
    .dose .note{
      margin:0;
      font-size: 14px;
      color: var(--muted);
      line-height: 1.25;
      word-break: break-word;
    }

    /* ===== SEMANA (MATRIZ COMPACTA) ===== */
    .weekly{ padding: 14px; }

    .table-wrap{
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
    }

    table.week-matrix{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      min-width: 720px;
    }

    .week-matrix th, .week-matrix td{
      border-bottom: 1px solid rgba(255,255,255,0.10);
      border-right: 1px solid rgba(255,255,255,0.08);
      padding: 10px 10px;
      vertical-align: middle;
    }

    .week-matrix th:last-child, .week-matrix td:last-child{ border-right:none; }

    .week-matrix th{
      text-align:center;
      font-size: 13px;
      color: rgba(241,211,139,0.95);
      background: rgba(214,179,90,0.08);
      letter-spacing: .2px;
      white-space:nowrap;
    }

    .week-matrix th.sticky-col,
    .week-matrix td.sticky-col{
      position: sticky;
      left: 0;
      z-index: 5;
      text-align:left;
      background: rgba(0,0,0,0.28);
      backdrop-filter: blur(6px);
    }

    .week-matrix th.sticky-col{ width: 320px; }
    .week-matrix th:not(.sticky-col){ width: calc((100% - 320px)/7); }

    .week-matrix td{
      font-size: 14px;
      color: var(--text);
      text-align:center;
    }

    .week-matrix td.sticky-col{
      text-align:left;
      font-weight: 800;
    }

    .week-matrix tr.group td{
      text-align:left;
      font-weight: 900;
      letter-spacing: .2px;
      color: rgba(241,211,139,0.95);
      background: rgba(255,255,255,0.03);
    }

    .wkmark{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 24px;
      height: 24px;
      font-weight: 900;
      color: var(--gold2);
      border: 1px solid rgba(214,179,90,0.22);
      border-radius: 8px;
      user-select:none;
    }

    .wkmark.offday{
      opacity: .28;
    }

    .week-cards{ display:none; }

    .week-matrix th.is-today{
      outline: 2px solid rgba(214,179,90,0.35);
      outline-offset: -2px;
    }

    .week-matrix td.is-today{
      background: rgba(214,179,90,0.06);
    }

    /* m√≥vil: se oculta tabla y se usan cards */
    @media (max-width: 820px){
      body{ padding: 14px; }
      .table-wrap{ display:none; }
      .week-cards{
        display:grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .day-card{
        border: 1px solid rgba(255,255,255,0.10);
        border-radius: 16px;
        background: rgba(0,0,0,0.18);
        padding: 12px;
      }
      .day-card .dh{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255,255,255,0.10);
        margin-bottom: 10px;
      }
      .day-card .dh strong{ font-size: 16px; }
      .day-card .today-pill{
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(214,179,90,0.30);
        color: rgba(241,211,139,0.95);
        background: rgba(214,179,90,0.10);
        display:none;
      }
      .day-card.is-today .today-pill{ display:inline-block; }
      .sec{ margin-top: 10px; }
      .sec-title{
        font-weight: 900;
        color: rgba(241,211,139,0.95);
        margin-bottom: 6px;
        font-size: 14px;
      }
      .mrow{
        display:flex;
        gap:10px;
        align-items:flex-start;
        padding: 6px 0;
      }
      .mtext{ font-size: 14px; line-height: 1.2; }
    }

    footer{
      margin-top: 4px;
      padding: 14px 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: rgba(199,202,211,0.95);
      font-size: 13px;
      border-top: 1px solid rgba(255,255,255,0.10);
      text-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
    footer .right{ display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
    .sep{ width:6px;height:6px;border-radius:999px; background: rgba(214,179,90,0.65); box-shadow: 0 0 0 4px rgba(214,179,90,0.10); }
    .gold{ color: rgba(241,211,139,0.95); }

    /* ===== MOBILE FIX (header + cards) ===== */
    @media (max-width: 560px){

      body{ padding: 12px; }

      .page{ max-width: 100%; }

      header{
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 14px;
      }

      .brand{
        min-width: 0;
        width: 100%;
        gap: 10px;
      }

      .brand img{
        width: 54px;
        height: 54px;
        border-radius: 12px;
      }

      .brand h1{
        font-size: 18px;
        line-height: 1.15;
      }

      .pill{
        font-size: 12px;
        padding: 7px 10px;
        width: 100%;
      }

      .actions{
        width: 100%;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        justify-content: stretch;
      }

      button{
        width: 100%;
        justify-content: center;
        padding: 12px 10px;
        border-radius: 14px;
      }

      .card-head{
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .dose{
        padding: 10px;
      }
      .dose .name{ font-size: 15px; }
      .dose .note{ font-size: 13px; }

      .week-cards{ margin-top: 10px; }

      .day-card{ padding: 12px; }

      .day-card .dh strong{ font-size: 17px; }

      .wkmark{
        min-width: 26px;
        height: 26px;
        border-radius: 8px;
      }
    }

    /* ===== IMPRESI√ìN (Carta) ===== */
    @page { size: letter; margin: 0.55in; }
    @media print{
      body{
        padding:0;
        background: #fff !important;
        color: #111 !important;
      }
      body::before, body::after{ display:none !important; }
      .page{ max-width: none; }
      header, .card, footer{
        box-shadow: none !important;
        backdrop-filter: none !important;
      }
      header, .card{
        border: 1px solid #ddd !important;
        background: #fff !important;
        color: #111 !important;
      }
      .pill, .badge{
        border: 1px solid #ccc !important;
        background: #f7f7f7 !important;
        color: #333 !important;
      }
      .badge.gold, .week-matrix th{
        color: #6a4b00 !important;
        background: #fff7e6 !important;
        border-color: #e7d3a6 !important;
      }
      .dose, .block, .table-wrap{
        border-color: #ddd !important;
        background: #fff !important;
      }
      .dose .note, footer{ color:#333 !important; }
      .actions{ display:none !important; }
      .week-cards{ display:none !important; }
      .table-wrap{ display:block !important; }
      table.week-matrix{ min-width: 0; width:100%; }
    }
  </style>
</head>

<body>
  <div class="page">

    <header>
      <div class="brand">
        <img src="./logo.png" alt="Logo" />
        <div class="t">
          <h1>Calendario de medicamentos</h1>
          <div class="pill">Impresi√≥n Carta ‚Ä¢ Marcar rutina (se guarda) ‚Ä¢ Semana = espejo de HOY</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn-gold" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        <button class="btn-danger" onclick="clearAll()">üßº Limpiar marcas</button>
      </div>
    </header>

    <!-- RUTINA DIARIA -->
    <section class="card">
      <div class="card-head">
        <h2>üïí Rutina diaria</h2>
        <span class="badge gold" id="todayBadge">Hoy</span>
      </div>

      <div class="routine">

        <!-- MA√ëANA -->
        <div class="block">
          <div class="bh">
            <strong>üå§Ô∏è Ma√±ana</strong>
            <span>despu√©s / seg√∫n indique</span>
          </div>
          <div class="bl">

            <div class="dose">
              <input type="checkbox" data-key="amiodarona_am" />
              <div class="txt">
                <p class="name">Amiodarona (¬Ω tableta)</p>
                <p class="note">Ma√±ana</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="rivaroxaban_am" />
              <div class="txt">
                <p class="name">Rivaroxaban 15 mg (¬Ω tableta)</p>
                <p class="note">Ma√±ana</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="acido_folico_am" />
              <div class="txt">
                <p class="name">√Åcido f√≥lico</p>
                <p class="note">Ma√±ana</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="zyplo_am" />
              <div class="txt">
                <p class="name">Zyplo 10 ml</p>
                <p class="note">Cada 8 horas (primera dosis en la ma√±ana)</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="linezolid_am" />
              <div class="txt">
                <p class="name">Linezolid (1 tableta)</p>
                <p class="note">Cada 12 horas ‚Ä¢ despu√©s de las comidas</p>
              </div>
            </div>

          </div>
        </div>

        <!-- TARDE -->
        <div class="block">
          <div class="bh">
            <strong>üåá Tarde</strong>
            <span>horarios</span>
          </div>
          <div class="bl">

            <div class="dose">
              <input type="checkbox" data-key="omeprazol_pm" />
              <div class="txt">
                <p class="name">Omeprazol</p>
                <p class="note">Tarde</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="ziplo_5pm" />
              <div class="txt">
                <p class="name">Ziplo 10 ml</p>
                <p class="note">5:00 pm</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="inhalador_6pm" />
              <div class="txt">
                <p class="name">Inhalador</p>
                <p class="note">6:00 pm</p>
              </div>
            </div>

          </div>
        </div>

        <!-- NOCHE -->
        <div class="block">
          <div class="bh">
            <strong>üåô Noche</strong>
            <span>cierre del d√≠a</span>
          </div>
          <div class="bl">

            <div class="dose">
              <input type="checkbox" data-key="insulina_night" />
              <div class="txt">
                <p class="name">Insulina</p>
                <p class="note">Noche</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="sulfato_ferroso_night" />
              <div class="txt">
                <p class="name">Sulfato ferroso</p>
                <p class="note">Noche</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="zyplo_night" />
              <div class="txt">
                <p class="name">Zyplo</p>
                <p class="note">Noche (siguiente dosis cada 8h)</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="linezolid_night" />
              <div class="txt">
                <p class="name">Linezolid (1 tableta)</p>
                <p class="note">Despu√©s de cenar (cada 12h)</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="ertapenem_iv_night" />
              <div class="txt">
                <p class="name">Ertapenem IV</p>
                <p class="note">Noche</p>
              </div>
            </div>

            <!-- EPO: SOLO TEXTO arriba (NO se marca aqu√≠) -->
            <div class="dose">
              <div class="txt">
                <p class="name">Eritropoyetina</p>
                <p class="note">Lunes / Mi√©rcoles / Viernes (marcar en ‚ÄúSemana‚Äù)</p>
              </div>
            </div>

          </div>
        </div>

      </div>
    </section>

    <!-- SEMANA (MATRIZ COMPACTA) -->
    <section class="card">
      <div class="card-head">
        <h2>üìÖ Semana (vista autom√°tica)</h2>
        <span class="badge">Marcas arriba ‚Üí abajo solo refleja HOY ‚úÖ</span>
      </div>

      <div class="weekly">
        <div class="table-wrap" id="weekWrap">
          <table class="week-matrix" id="weekMatrix">
            <thead>
              <tr>
                <th class="sticky-col">Medicamento</th>
                <th data-day="mon">L</th>
                <th data-day="tue">M</th>
                <th data-day="wed">X</th>
                <th data-day="thu">J</th>
                <th data-day="fri">V</th>
                <th data-day="sat">S</th>
                <th data-day="sun">D</th>
              </tr>
            </thead>
            <tbody id="weekBody">
              <!-- JS construye filas -->
            </tbody>
          </table>
        </div>
        <div class="week-cards" id="weekCards"></div>
      </div>
    </section>

    <footer>
      <div>¬© <span id="year"></span> <span class="gold">Derechos reservados</span></div>
      <div class="right">
        <span class="sep"></span>
        <div>Powered by <strong class="gold">Cobian PC</strong></div>
      </div>
    </footer>
  </div>

  <script>
    // =========================
    // STORAGE + RESET LUNES (ISO)
    // =========================
    const STORAGE_KEY = "meds_calendar_letter_v2_iso";
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : { checked: {}, weekStamp: "" };
      }catch(_){
        return { checked: {}, weekStamp: "" };
      }
    }
    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    const state = loadState();

    // ISO week stamp: YYYY-Www (semana empieza lunes)
    function getISOWeekStamp(d=new Date()){
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const day = date.getUTCDay() || 7; // 1=Mon..7=Sun
      date.setUTCDate(date.getUTCDate() + 4 - day); // a jueves
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
      const yyyy = date.getUTCFullYear();
      const ww = String(weekNo).padStart(2,"0");
      return `${yyyy}-W${ww}`;
    }

    // si cambi√≥ la semana ISO ‚Üí limpia SOLO rutina diaria (no epo_*)
    function enforceWeeklyReset(){
      const stampNow = getISOWeekStamp();
      if(state.weekStamp && state.weekStamp === stampNow) return;

      const nextChecked = {};
      for(const [k,v] of Object.entries(state.checked || {})){
        if(k.startsWith("epo_")) nextChecked[k] = v;
      }
      state.checked = nextChecked;
      state.weekStamp = stampNow;
      saveState();
    }

    // =========================
    // MAPEOS (rutina diaria)
    // =========================
    const ROUTINE_MAP = {
      morning: [
        { key:"amiodarona_am",   label:"Amiodarona (¬Ω)" },
        { key:"rivaroxaban_am",  label:"Rivaroxaban 15mg (¬Ω)" },
        { key:"acido_folico_am", label:"√Åcido f√≥lico" },
        { key:"zyplo_am",        label:"Zyplo 10 ml (c/8h)" },
        { key:"linezolid_am",    label:"Linezolid (1) (c/12h)" }
      ],
      afternoon: [
        { key:"omeprazol_pm",    label:"Omeprazol" },
        { key:"ziplo_5pm",       label:"Ziplo 10 ml (5:00 pm)" },
        { key:"inhalador_6pm",   label:"Inhalador (6:00 pm)" }
      ],
      night: [
        { key:"insulina_night",          label:"Insulina" },
        { key:"sulfato_ferroso_night",   label:"Sulfato ferroso" },
        { key:"zyplo_night",             label:"Zyplo (c/8h)" },
        { key:"linezolid_night",         label:"Linezolid (1) despu√©s de cenar" },
        { key:"ertapenem_iv_night",      label:"Ertapenem IV" }
      ]
    };

    const DAY_LABELS = {
      mon:"Lunes", tue:"Martes", wed:"Mi√©rcoles", thu:"Jueves",
      fri:"Viernes", sat:"S√°bado", sun:"Domingo"
    };

    function getTodayDayKey(){
      const d = new Date(); // 0=Dom..6=S√°b
      const map = ["sun","mon","tue","wed","thu","fri","sat"];
      return map[d.getDay()];
    }

    // =========================
    // BIND CHECKBOXES (arriba)
    // =========================
    function bindChecks(){
      document.querySelectorAll('input[type="checkbox"][data-key]').forEach(cb => {
        const k = cb.getAttribute("data-key");
        cb.checked = !!state.checked[k];

        cb.addEventListener("change", () => {
          state.checked[k] = cb.checked;
          saveState();
          renderWeekMirror();
        });
      });
    }

    function clearAll(){
      if(!confirm("¬øSeguro que quieres limpiar todas las marcas?")) return;

      // Limpia rutina diaria, pero respeta EPO
      const nextChecked = {};
      for(const [k,v] of Object.entries(state.checked || {})){
        if(k.startsWith("epo_")) nextChecked[k] = v;
      }
      state.checked = nextChecked;

      saveState();
      document.querySelectorAll('input[type="checkbox"][data-key]').forEach(cb => {
        const k = cb.getAttribute("data-key");
        cb.checked = !!state.checked[k];
      });
      renderWeekMirror();
    }
    window.clearAll = clearAll;

    // =========================
    // SEMANA: MATRIZ COMPACTA
    // =========================
    const WEEK_MATRIX = [
      { group: "üå§Ô∏è Ma√±ana", items: ROUTINE_MAP.morning },
      { group: "üåá Tarde",  items: ROUTINE_MAP.afternoon },
      { group: "üåô Noche",  items: ROUTINE_MAP.night },
      { group: "üíâ Eritropoyetina (L-M-V)", items: [
          { key:"epo_mon", label:"Eritropoyetina (Lunes)" },
          { key:"epo_wed", label:"Eritropoyetina (Mi√©rcoles)" },
          { key:"epo_fri", label:"Eritropoyetina (Viernes)" },
        ]
      }
    ];

    function buildWeekMatrix(){
      const tbody = document.getElementById("weekBody");
      if(!tbody) return;

      const days = ["mon","tue","wed","thu","fri","sat","sun"];
      tbody.innerHTML = "";

      WEEK_MATRIX.forEach(block => {
        const trg = document.createElement("tr");
        trg.className = "group";
        trg.innerHTML = `<td class="sticky-col" colspan="8">${block.group}</td>`;
        tbody.appendChild(trg);

        (block.items || []).forEach(it => {
          const tr = document.createElement("tr");

          const left = document.createElement("td");
          left.className = "sticky-col";
          left.textContent = it.label;
          tr.appendChild(left);

          days.forEach(d => {
            const td = document.createElement("td");
            td.setAttribute("data-day", d);
            td.innerHTML = `<span class="wkmark" data-day="${d}" data-key="${it.key}">‚òê</span>`;
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });
      });
    }

    function renderWeekMirror(){
      const today = getTodayDayKey();
      const days = ["mon","tue","wed","thu","fri","sat","sun"];

      // resalta columna hoy (desktop table)
      const table = document.getElementById("weekMatrix");
      if(table){
        table.querySelectorAll("thead th").forEach(th => th.classList.remove("is-today"));
        table.querySelectorAll("tbody td").forEach(td => td.classList.remove("is-today"));

        const idx = days.indexOf(today);
        if(idx >= 0){
          const col = idx + 2; // +1 por sticky
          const thToday = table.querySelector(`thead th:nth-child(${col})`);
          if(thToday) thToday.classList.add("is-today");
          table.querySelectorAll("tbody tr").forEach(tr => {
            const td = tr.querySelector(`td:nth-child(${col})`);
            if(td) td.classList.add("is-today");
          });
        }
      }

      // pinta marks: Rutina SOLO HOY, EPO por su d√≠a real
      document.querySelectorAll('.wkmark[data-day][data-key]').forEach(el => {
        const day = el.getAttribute("data-day");
        const key = el.getAttribute("data-key");
        const isToday = (day === today);
        const isEpo = key.startsWith("epo_");
        const checked = !!state.checked[key];

        if (isEpo) {
          el.textContent = checked ? "‚úÖ" : "‚òê";
          el.classList.toggle("offday", false);
        } else {
          if (isToday) {
            el.textContent = checked ? "‚úÖ" : "‚òê";
            el.classList.toggle("offday", false);
          } else {
            el.textContent = "‚òê";
            el.classList.toggle("offday", true);
          }
        }
      });

      const wrap = document.getElementById("weekWrap");
      if(wrap) wrap.scrollLeft = 0;

      renderWeekCards(today);
    }

    function renderWeekCards(today){
      const mount = document.getElementById("weekCards");
      if(!mount) return;

      const days = ["mon","tue","wed","thu","fri","sat","sun"];
      const blocks = [
        { title:"üå§Ô∏è Ma√±ana", items: ROUTINE_MAP.morning },
        { title:"üåá Tarde",  items: ROUTINE_MAP.afternoon },
        { title:"üåô Noche",  items: ROUTINE_MAP.night }
      ];

      mount.innerHTML = "";

      days.forEach(day => {
        const isToday = (day === today);

        const card = document.createElement("div");
        card.className = "day-card" + (isToday ? " is-today" : "");

        let html = `
          <div class="dh">
            <strong>${DAY_LABELS[day]}</strong>
            <span class="today-pill">HOY</span>
          </div>
        `;

        blocks.forEach(b => {
          html += `<div class="sec"><div class="sec-title">${b.title}</div>`;
          b.items.forEach(it => {
            const checked = !!state.checked[it.key];
            const mark = isToday ? (checked ? "‚úÖ" : "‚òê") : "‚òê";
            const dim  = isToday ? "" : " style=\"opacity:.35\"";
            html += `
              <div class="mrow"${dim}>
                <span class="wkmark">${mark}</span>
                <div class="mtext">${it.label}</div>
              </div>
            `;
          });
          html += `</div>`;
        });

        // EPO (L-M-V) por d√≠a real (tambi√©n en m√≥vil)
        html += `<div class="sec"><div class="sec-title">üíâ Eritropoyetina</div>`;
        const epoMap = { mon:"epo_mon", wed:"epo_wed", fri:"epo_fri" };
        if(epoMap[day]){
          const k = epoMap[day];
          const checked = !!state.checked[k];
          html += `
            <div class="mrow">
              <span class="wkmark">${checked ? "‚úÖ" : "‚òê"}</span>
              <div class="mtext">Aplicada</div>
            </div>
          `;
        }else{
          html += `
            <div class="mrow" style="opacity:.35">
              <span class="wkmark">‚Äî</span>
              <div class="mtext">No aplica</div>
            </div>
          `;
        }
        html += `</div>`;

        card.innerHTML = html;
        mount.appendChild(card);
      });
    }

    // click en EPO (semana): toggle y guardar (desktop table + mobile cards NO son inputs)
    // hacemos delegaci√≥n en la tabla: si tocan un wkmark de epo_ se togglea
    document.addEventListener("click", (ev) => {
      const el = ev.target && ev.target.closest ? ev.target.closest(".wkmark[data-key]") : null;
      if(!el) return;
      const key = el.getAttribute("data-key");
      if(!key || !key.startsWith("epo_")) return;

      // toggle
      state.checked[key] = !state.checked[key];
      saveState();
      renderWeekMirror();
    });

    // =========================
    // INIT
    // =========================
    enforceWeeklyReset();

    document.getElementById("year").textContent = new Date().getFullYear();
    const todayName = DAY_LABELS[getTodayDayKey()] || "Hoy";
    document.getElementById("todayBadge").textContent = `Hoy: ${todayName} ‚Ä¢ ${getISOWeekStamp()}`;

    bindChecks();
    buildWeekMatrix();
    renderWeekMirror();
  </script>
</body>
</html>
