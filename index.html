<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendario de Medicamentos (Impresi√≥n Carta)</title>
  <link rel="icon" type="image/x-icon" href="./logo.ico" />

  <style>
    :root{
      --bg0:#07080b;
      --bg2:#0d0f16;
      --paper:#0b0d12;

      --text:#f3f4f7;
      --muted:#c7cad3;

      --gold:#d6b35a;
      --gold2:#f1d38b;

      --line: rgba(255,255,255,0.10);
      --shadow2: 0 14px 34px rgba(0,0,0,0.45);

      --r:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(214,179,90,0.14), transparent 58%),
        radial-gradient(900px 520px at 100% 10%, rgba(214,179,90,0.10), transparent 62%),
        radial-gradient(1100px 700px at 60% 120%, rgba(241,211,139,0.08), transparent 65%),
        linear-gradient(180deg, var(--bg0), var(--bg2));
      padding: 22px;
      overflow-x:hidden;
      display:flex;
      justify-content:center;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background: url("./logo.png") center 22% / 540px auto no-repeat;
      opacity: 0.035;
      filter: saturate(1.1) contrast(1.05);
      transform: translateZ(0);
    }

    body::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
      opacity: .05;
      mix-blend-mode: overlay;
    }

    .page{
      width:100%;
      max-width: 1020px;
      display:flex;
      flex-direction:column;
      gap: 16px;
      position:relative;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 16px 16px;
      border-radius: var(--r);
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
      box-shadow: var(--shadow2);
      backdrop-filter: blur(12px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 280px;
    }
    .brand img{
      width: 68px;
      height: 68px;
      border-radius: 14px;
      object-fit: contain;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(214,179,90,0.28);
      box-shadow: 0 12px 22px rgba(0,0,0,0.35);
      padding: 6px;
    }
    .brand .t{display:flex; flex-direction:column; gap:6px;}
    .brand h1{
      margin:0;
      font-size: 20px;          /* M√ÅS GRANDE */
      letter-spacing: .2px;
      font-weight: 820;
      line-height: 1.1;
    }
    .pill{
      width: fit-content;
      font-size: 14px;          /* M√ÅS GRANDE */
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.25);
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    button{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      cursor:pointer;
      transition: .16s ease;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
      font-size: 14px;
    }
    button:hover{
      transform: translateY(-1px);
      background: rgba(0,0,0,0.30);
      border-color: rgba(214,179,90,0.28);
      box-shadow: 0 10px 20px rgba(0,0,0,0.32);
    }
    button:active{ transform: translateY(0px); box-shadow:none; }

    .btn-gold{
      border-color: rgba(214,179,90,0.36);
      background: linear-gradient(180deg, rgba(214,179,90,0.22), rgba(0,0,0,0.18));
    }
    .btn-danger{
      border-color: rgba(255,77,109,0.35);
      background: linear-gradient(180deg, rgba(255,77,109,0.16), rgba(0,0,0,0.18));
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
      align-items:start;
    }

    .card{
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }

    .card-head{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
    }
    .card-head h2{
      margin:0;
      font-size: 16px; /* M√ÅS GRANDE */
      letter-spacing: .25px;
      display:flex;
      gap:10px;
      align-items:center;
      font-weight: 850;
    }
    .badge{
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--muted);
      background: rgba(0,0,0,0.20);
    }
    .badge.gold{
      border-color: rgba(214,179,90,0.32);
      color: rgba(241,211,139,0.95);
      background: rgba(214,179,90,0.10);
    }

    /* ===== RUTINA (ma√±ana/tarde/noche) ===== */
    .routine{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 14px;
    }
    @media (max-width: 860px){
      .routine{ grid-template-columns: 1fr; }
    }

    .block{
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      background: rgba(0,0,0,0.16);
      overflow:hidden;
    }
    .block .bh{
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
    }
    .block .bh strong{
      font-size: 16px;
      letter-spacing: .2px;
    }
    .block .bh span{
      font-size: 13px;
      color: var(--muted);
    }
    .block .bl{
      padding: 10px 12px 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .dose{
      display:flex;
      align-items:flex-start;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
    }

    /* checkbox grande para imprimir */
    .dose input[type="checkbox"]{
      width: 22px;
      height: 22px;
      accent-color: var(--gold);
      margin-top: 2px;
      flex: 0 0 auto;
      cursor:pointer;
    }

    .dose .txt{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width:0;
    }
    .dose .name{
      margin:0;
      font-size: 16px;     /* MUY LEGIBLE */
      font-weight: 850;
      line-height: 1.15;
      word-break: break-word;
    }
    .dose .note{
      margin:0;
      font-size: 14px;     /* MUY LEGIBLE */
      color: var(--muted);
      line-height: 1.25;
    }

    /* ===== TABLA SEMANAL ===== */
    .weekly{
      padding: 14px;
    }
    .table-wrap{
      overflow:auto;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 920px; /* para que en escritorio se vea completo */
    }
    th, td{
      border-bottom: 1px solid rgba(255,255,255,0.10);
      border-right: 1px solid rgba(255,255,255,0.08);
      padding: 12px 10px;
      vertical-align:top;
    }
    th:last-child, td:last-child{ border-right: none; }
    th{
      text-align:left;
      font-size: 14px;
      color: rgba(241,211,139,0.95);
      background: rgba(214,179,90,0.08);
      letter-spacing: .2px;
    }
    td{
      font-size: 14px;
      color: var(--text);
    }
    .cell-title{
      font-weight: 850;
      font-size: 14px;
      margin-bottom: 6px;
      color: rgba(241,211,139,0.95);
    }
    .mini{
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .mini .mrow{
      display:flex;
      gap: 8px;
      align-items:flex-start;
    }
    .mini input[type="checkbox"]{
      width: 18px;
      height: 18px;
      accent-color: var(--gold);
      margin-top: 2px;
      flex:0 0 auto;
    }
    .mini .mtext{
      line-height: 1.2;
    }

    /* ===== Semana completa visible / scroll bien ===== */
    table.weekview{
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed; /* clave: reparte columnas */
      min-width: 1100px;   /* asegura 7 d√≠as sin apretar feo */
    }

    table.weekview th, table.weekview td{
      width: calc((100% - 160px)/7);
    }

    table.weekview th.sticky-col,
    table.weekview td.sticky-col{
      position: sticky;
      left: 0;
      z-index: 3;
      background: rgba(0,0,0,0.22);
      backdrop-filter: blur(6px);
    }

    /* marca semanal solo lectura */
    .wkmark{
      display:inline-block;
      min-width: 18px;
      text-align:center;
      font-weight: 900;
      color: var(--gold2);
      border: 1px solid rgba(214,179,90,0.22);
      border-radius: 6px;
      padding: 2px 6px;
      user-select:none;
    }
    .wkmark.disabled{
      opacity:.35;
      border-color: rgba(255,255,255,0.10);
      color: var(--muted);
    }

    /* compacta los textos dentro de celdas */
    table.weekview .mtext{ font-size: 13px; }

    footer{
      margin-top: 4px;
      padding: 14px 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: rgba(199,202,211,0.95);
      font-size: 13px;
      border-top: 1px solid rgba(255,255,255,0.10);
      text-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
    footer .right{ display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
    .sep{ width:6px;height:6px;border-radius:999px; background: rgba(214,179,90,0.65); box-shadow: 0 0 0 4px rgba(214,179,90,0.10); }
    .gold{ color: rgba(241,211,139,0.95); }

    /* ===== IMPRESI√ìN (Carta) ===== */
    @page { size: letter; margin: 0.55in; }

    @media print{
      body{
        padding:0;
        background: #fff !important;
        color: #111 !important;
      }
      body::before, body::after{ display:none !important; }
      .page{ max-width: none; }
      header, .card, footer{
        box-shadow: none !important;
        backdrop-filter: none !important;
      }
      header, .card{
        border: 1px solid #ddd !important;
        background: #fff !important;
        color: #111 !important;
      }
      .pill, .badge{
        border: 1px solid #ccc !important;
        background: #f7f7f7 !important;
        color: #333 !important;
      }
      .badge.gold, th{
        color: #6a4b00 !important;
        background: #fff7e6 !important;
        border-color: #e7d3a6 !important;
      }
      .dose, .block, .table-wrap{
        border-color: #ddd !important;
        background: #fff !important;
      }
      .dose .note, footer{ color:#333 !important; }
      .actions{ display:none !important; } /* oculta botones al imprimir */
      table{ min-width: 0; }             /* imprime ajustado */
    }
  </style>
</head>

<body>
  <div class="page">

    <header>
      <div class="brand">
        <img src="./logo.png" alt="Logo" />
        <div class="t">
          <h1>Calendario de medicamentos</h1>
          <div class="pill">Impresi√≥n Carta ‚Ä¢ Marcar dosis (checkbox)</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn-gold" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        <button class="btn-danger" onclick="clearAll()">üßº Limpiar marcas</button>
      </div>
    </header>

    <!-- RUTINA DIARIA -->
    <section class="card">
      <div class="card-head">
        <h2>üïí Rutina diaria</h2>
        <span class="badge gold">Ma√±ana ‚Ä¢ Tarde ‚Ä¢ Noche</span>
      </div>

      <div class="routine">

        <!-- MA√ëANA -->
        <div class="block">
          <div class="bh">
            <strong>üå§Ô∏è Ma√±ana</strong>
            <span>despu√©s / seg√∫n indique</span>
          </div>
          <div class="bl">

            <div class="dose">
              <input type="checkbox" data-key="amiodarona_am" />
              <div class="txt">
                <p class="name">Amiodarona (¬Ω tableta)</p>
                <p class="note">Ma√±ana</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="rivaroxaban_am" />
              <div class="txt">
                <p class="name">Rivaroxaban 15 mg (¬Ω tableta)</p>
                <p class="note">Ma√±ana</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="acido_folico_am" />
              <div class="txt">
                <p class="name">√Åcido f√≥lico</p>
                <p class="note">Ma√±ana</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="zyplo_am" />
              <div class="txt">
                <p class="name">Zyplo 10 ml</p>
                <p class="note">Cada 8 horas (primera dosis en la ma√±ana)</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="linezolid_am" />
              <div class="txt">
                <p class="name">Linezolid (1 tableta)</p>
                <p class="note">Cada 12 horas ‚Ä¢ despu√©s de las comidas</p>
              </div>
            </div>

          </div>
        </div>

        <!-- TARDE -->
        <div class="block">
          <div class="bh">
            <strong>üåá Tarde</strong>
            <span>horarios</span>
          </div>
          <div class="bl">

            <div class="dose">
              <input type="checkbox" data-key="omeprazol_pm" />
              <div class="txt">
                <p class="name">Omeprazol</p>
                <p class="note">Tarde</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="ziplo_5pm" />
              <div class="txt">
                <p class="name">Ziplo 10 ml</p>
                <p class="note">5:00 pm</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="inhalador_6pm" />
              <div class="txt">
                <p class="name">Inhalador</p>
                <p class="note">6:00 pm</p>
              </div>
            </div>

          </div>
        </div>

        <!-- NOCHE -->
        <div class="block">
          <div class="bh">
            <strong>üåô Noche</strong>
            <span>cierre del d√≠a</span>
          </div>
          <div class="bl">

            <div class="dose">
              <input type="checkbox" data-key="insulina_night" />
              <div class="txt">
                <p class="name">Insulina</p>
                <p class="note">Noche</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="sulfato_ferroso_night" />
              <div class="txt">
                <p class="name">Sulfato ferroso</p>
                <p class="note">Noche</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="zyplo_night" />
              <div class="txt">
                <p class="name">Zyplo</p>
                <p class="note">Noche (siguiente dosis cada 8h)</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="linezolid_night" />
              <div class="txt">
                <p class="name">Linezolid (1 tableta)</p>
                <p class="note">Despu√©s de cenar (cada 12h)</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="ertapenem_iv_night" />
              <div class="txt">
                <p class="name">Ertapenem IV</p>
                <p class="note">Noche</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="eritropoyetina_mwf" />
              <div class="txt">
                <p class="name">Eritropoyetina</p>
                <p class="note">Lunes ‚Ä¢ Mi√©rcoles ‚Ä¢ Viernes</p>
              </div>
            </div>

          </div>
        </div>

      </div>
    </section>

    <!-- CALENDARIO SEMANAL (VISTA) -->
    <section class="card">
      <div class="card-head">
        <h2>üóìÔ∏è Semana (vista autom√°tica)</h2>
        <span class="badge">Marcas arriba ‚Üí aqu√≠ solo se refleja ‚úÖ</span>
      </div>

      <div class="weekly">
        <div class="table-wrap">
          <table class="weekview">
            <thead>
              <tr>
                <th class="sticky-col" style="width:160px;">Bloque</th>
                <th>Lunes</th>
                <th>Martes</th>
                <th>Mi√©rcoles</th>
                <th>Jueves</th>
                <th>Viernes</th>
                <th>S√°bado</th>
                <th>Domingo</th>
              </tr>
            </thead>

            <tbody>
              <!-- MA√ëANA -->
              <tr>
                <td class="sticky-col">
                  <div class="cell-title">Ma√±ana</div>
                  <div style="color:var(--muted); font-size:13px;">Rutina</div>
                </td>

                <!-- Cada d√≠a tiene solo "palomitas" autom√°ticas -->
                <td><div class="mini" data-day="mon" data-block="morning"></div></td>
                <td><div class="mini" data-day="tue" data-block="morning"></div></td>
                <td><div class="mini" data-day="wed" data-block="morning"></div></td>
                <td><div class="mini" data-day="thu" data-block="morning"></div></td>
                <td><div class="mini" data-day="fri" data-block="morning"></div></td>
                <td><div class="mini" data-day="sat" data-block="morning"></div></td>
                <td><div class="mini" data-day="sun" data-block="morning"></div></td>
              </tr>

              <!-- TARDE -->
              <tr>
                <td class="sticky-col">
                  <div class="cell-title">Tarde</div>
                  <div style="color:var(--muted); font-size:13px;">Rutina</div>
                </td>
                <td><div class="mini" data-day="mon" data-block="afternoon"></div></td>
                <td><div class="mini" data-day="tue" data-block="afternoon"></div></td>
                <td><div class="mini" data-day="wed" data-block="afternoon"></div></td>
                <td><div class="mini" data-day="thu" data-block="afternoon"></div></td>
                <td><div class="mini" data-day="fri" data-block="afternoon"></div></td>
                <td><div class="mini" data-day="sat" data-block="afternoon"></div></td>
                <td><div class="mini" data-day="sun" data-block="afternoon"></div></td>
              </tr>

              <!-- NOCHE -->
              <tr>
                <td class="sticky-col">
                  <div class="cell-title">Noche</div>
                  <div style="color:var(--muted); font-size:13px;">Rutina</div>
                </td>
                <td><div class="mini" data-day="mon" data-block="night"></div></td>
                <td><div class="mini" data-day="tue" data-block="night"></div></td>
                <td><div class="mini" data-day="wed" data-block="night"></div></td>
                <td><div class="mini" data-day="thu" data-block="night"></div></td>
                <td><div class="mini" data-day="fri" data-block="night"></div></td>
                <td><div class="mini" data-day="sat" data-block="night"></div></td>
                <td><div class="mini" data-day="sun" data-block="night"></div></td>
              </tr>

              <!-- ERITROPOYETINA (solo L-M-V idealmente, pero t√∫ puedes ver toda semana) -->
              <tr>
                <td class="sticky-col">
                  <div class="cell-title">Eritropoyetina</div>
                  <div style="color:var(--muted); font-size:13px;">L-M-V</div>
                </td>

                <td><div class="mini"><div class="mrow"><span class="wkmark" data-key="epo_mon">‚òê</span><div class="mtext">Aplicada</div></div></div></td>
                <td><div class="mini"><div class="mrow"><span class="wkmark disabled">‚Äî</span><div class="mtext">‚Äî</div></div></div></td>
                <td><div class="mini"><div class="mrow"><span class="wkmark" data-key="epo_wed">‚òê</span><div class="mtext">Aplicada</div></div></div></td>
                <td><div class="mini"><div class="mrow"><span class="wkmark disabled">‚Äî</span><div class="mtext">‚Äî</div></div></div></td>
                <td><div class="mini"><div class="mrow"><span class="wkmark" data-key="epo_fri">‚òê</span><div class="mtext">Aplicada</div></div></div></td>
                <td><div class="mini"><div class="mrow"><span class="wkmark disabled">‚Äî</span><div class="mtext">‚Äî</div></div></div></td>
                <td><div class="mini"><div class="mrow"><span class="wkmark disabled">‚Äî</span><div class="mtext">‚Äî</div></div></div></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <footer>
      <div>¬© <span id="year"></span> <span class="gold">Derechos reservados</span></div>
      <div class="right">
        <span class="sep"></span>
        <div>Powered by <strong class="gold">Cobian PC</strong></div>
      </div>
    </footer>
  </div>

  <script>
    // =========================
    // STORAGE + RESET (diario y semanal)
    // =========================
    const STORAGE_KEY = "meds_calendar_letter_v3";

    const WEEKLY_PREFIXES = ["epo_"]; // semanal real: epo_ (si quieres reiniciar m√°s cosas, aqu√≠ se agrega)

    function ymdLocal(d = new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function getISOWeekKey(date = new Date()){
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      const week = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return `${d.getUTCFullYear()}-W${String(week).padStart(2, "0")}`;
    }

    function isWeeklyKey(k){
      return WEEKLY_PREFIXES.some(p => k.startsWith(p));
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : { checked: {}, lastDailyDate: null, lastWeekKey: null };
      }catch(_){
        return { checked: {}, lastDailyDate: null, lastWeekKey: null };
      }
    }

    function saveState(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){ console.warn(e); }
    }

    const state = loadState();

    function ensureDailyReset(){
      const today = ymdLocal();
      if(!state.lastDailyDate){
        state.lastDailyDate = today;
        saveState();
        return;
      }
      if(state.lastDailyDate !== today){
        // borra SOLO diarios (todo lo que NO sea semanal)
        Object.keys(state.checked || {}).forEach(k => {
          if(!isWeeklyKey(k)) delete state.checked[k];
        });
        state.lastDailyDate = today;
        saveState();
      }
    }

    function ensureWeeklyReset(){
      const wk = getISOWeekKey();
      if(!state.lastWeekKey){
        state.lastWeekKey = wk;
        saveState();
        return;
      }
      if(state.lastWeekKey !== wk){
        // borra SOLO semanales (epo_)
        Object.keys(state.checked || {}).forEach(k => {
          if(isWeeklyKey(k)) delete state.checked[k];
        });
        state.lastWeekKey = wk;
        saveState();
      }
    }

    // =========================
    // BIND arriba (rutina diaria)
    // =========================
    function bindDailyChecks(){
      document.querySelectorAll('input[type="checkbox"][data-key]').forEach(cb => {
        const k = cb.getAttribute("data-key");
        cb.checked = !!state.checked[k];

        cb.addEventListener("change", () => {
          state.checked[k] = cb.checked;
          saveState();
          renderWeekView(); // <- refleja abajo autom√°ticamente
        });
      });
    }

    function clearAll(){
      if(!confirm("¬øSeguro que quieres limpiar todas las marcas?")) return;

      state.checked = {};
      state.lastDailyDate = ymdLocal();
      state.lastWeekKey = getISOWeekKey();
      saveState();

      document.querySelectorAll('input[type="checkbox"][data-key]').forEach(cb => cb.checked = false);
      renderWeekView();
    }
    window.clearAll = clearAll;

    // =========================
    // VISTA SEMANAL (solo lectura)
    // =========================
    const ROUTINE_MAP = {
      morning: [
        { key: "amiodarona_am", label: "Amiodarona (¬Ω)" },
        { key: "rivaroxaban_am", label: "Rivaroxaban 15mg (¬Ω)" },
        { key: "acido_folico_am", label: "√Åcido f√≥lico" },
        { key: "zyplo_am", label: "Zyplo 10 ml (c/8h)" },
        { key: "linezolid_am", label: "Linezolid (1) (c/12h)" }
      ],
      afternoon: [
        { key: "omeprazol_pm", label: "Omeprazol" },
        { key: "ziplo_5pm", label: "Ziplo 10 ml (5:00 pm)" },
        { key: "inhalador_6pm", label: "Inhalador (6:00 pm)" }
      ],
      night: [
        { key: "insulina_night", label: "Insulina" },
        { key: "sulfato_ferroso_night", label: "Sulfato ferroso" },
        { key: "zyplo_night", label: "Zyplo (c/8h)" },
        { key: "linezolid_night", label: "Linezolid (1) despu√©s de cenar" },
        { key: "ertapenem_iv_night", label: "Ertapenem IV" }
      ]
    };

    function renderWeekView(){
      // 1) Render rutina (ma√±ana/tarde/noche) por d√≠a pero SOLO como ‚úÖ/‚òê
      document.querySelectorAll(".mini[data-day][data-block]").forEach(container => {
        const block = container.getAttribute("data-block");
        const items = ROUTINE_MAP[block] || [];
        container.innerHTML = "";

        items.forEach(it => {
          const done = !!state.checked[it.key];
          const row = document.createElement("div");
          row.className = "mrow";
          row.innerHTML = `
            <span class="wkmark">${done ? "‚úÖ" : "‚òê"}</span>
            <div class="mtext">${it.label}</div>
          `;
          container.appendChild(row);
        });
      });

      // 2) Render eritropoyetina (epo_) como ‚úÖ/‚òê (ya est√°n en HTML)
      document.querySelectorAll(".wkmark[data-key]").forEach(span => {
        const k = span.getAttribute("data-key");
        span.textContent = state.checked[k] ? "‚úÖ" : "‚òê";
      });
    }

    // =========================
    // INIT
    // =========================
    document.getElementById("year").textContent = new Date().getFullYear();

    ensureDailyReset();
    ensureWeeklyReset();

    bindDailyChecks();
    renderWeekView();
  </script>
</body>
</html>
