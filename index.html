<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calendario de Medicamentos (Impresi√≥n Carta)</title>
  <link rel="icon" type="image/x-icon" href="./logo.ico" />

  <style>
    :root{
      --bg0:#07080b;
      --bg2:#0d0f16;
      --text:#f3f4f7;
      --muted:#c7cad3;
      --gold:#d6b35a;
      --gold2:#f1d38b;
      --line: rgba(255,255,255,0.10);
      --shadow2: 0 14px 34px rgba(0,0,0,0.45);
      --r:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(214,179,90,0.14), transparent 58%),
        radial-gradient(900px 520px at 100% 10%, rgba(214,179,90,0.10), transparent 62%),
        radial-gradient(1100px 700px at 60% 120%, rgba(241,211,139,0.08), transparent 65%),
        linear-gradient(180deg, var(--bg0), var(--bg2));
      padding: 22px;
      overflow-x:hidden;
      display:flex;
      justify-content:center;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background: url("./logo.png") center 22% / 540px auto no-repeat;
      opacity: 0.035;
      filter: saturate(1.1) contrast(1.05);
      transform: translateZ(0);
    }

    body::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='120' height='120' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
      opacity: .05;
      mix-blend-mode: overlay;
    }

    .page{
      width:100%;
      max-width: 1020px;
      display:flex;
      flex-direction:column;
      gap: 16px;
      position:relative;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 16px 16px;
      border-radius: var(--r);
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
      box-shadow: var(--shadow2);
      backdrop-filter: blur(12px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 280px;
    }
    .brand img{
      width: 68px;
      height: 68px;
      border-radius: 14px;
      object-fit: contain;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(214,179,90,0.28);
      box-shadow: 0 12px 22px rgba(0,0,0,0.35);
      padding: 6px;
    }
    .brand .t{display:flex; flex-direction:column; gap:6px;}
    .brand h1{
      margin:0;
      font-size: 20px;
      letter-spacing: .2px;
      font-weight: 820;
      line-height: 1.1;
    }
    .pill{
      width: fit-content;
      font-size: 14px;
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.25);
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    button{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      cursor:pointer;
      transition: .16s ease;
      display:flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
      font-size: 14px;
      font-weight: 750;
    }
    button:hover{
      transform: translateY(-1px);
      background: rgba(0,0,0,0.30);
      border-color: rgba(214,179,90,0.28);
      box-shadow: 0 10px 20px rgba(0,0,0,0.32);
    }
    button:active{ transform: translateY(0px); box-shadow:none; }

    .btn-gold{
      border-color: rgba(214,179,90,0.36);
      background: linear-gradient(180deg, rgba(214,179,90,0.22), rgba(0,0,0,0.18));
    }
    .btn-danger{
      border-color: rgba(255,77,109,0.35);
      background: linear-gradient(180deg, rgba(255,77,109,0.16), rgba(0,0,0,0.18));
    }

    .card{
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }

    .card-head{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
    }
    .card-head h2{
      margin:0;
      font-size: 16px;
      letter-spacing: .25px;
      display:flex;
      gap:10px;
      align-items:center;
      font-weight: 850;
    }
    .badge{
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--muted);
      background: rgba(0,0,0,0.20);
      white-space:nowrap;
    }
    .badge.gold{
      border-color: rgba(214,179,90,0.32);
      color: rgba(241,211,139,0.95);
      background: rgba(214,179,90,0.10);
    }

    /* ===== RUTINA ===== */
    .routine{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 14px;
    }
    @media (max-width: 860px){
      .routine{ grid-template-columns: 1fr; }
    }

    .block{
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      background: rgba(0,0,0,0.16);
      overflow:hidden;
    }
    .block .bh{
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.16);
    }
    .block .bh strong{
      font-size: 16px;
      letter-spacing: .2px;
    }
    .block .bh span{
      font-size: 13px;
      color: var(--muted);
    }
    .block .bl{
      padding: 10px 12px 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .dose{
      display:flex;
      align-items:flex-start;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
    }
    .dose input[type="checkbox"]{
      width: 22px;
      height: 22px;
      accent-color: var(--gold);
      margin-top: 2px;
      flex: 0 0 auto;
      cursor:pointer;
    }

    .dose .txt{
      display:flex;
      flex-direction:column;
      gap: 4px;
      min-width:0;
    }
    .dose .name{
      margin:0;
      font-size: 16px;
      font-weight: 850;
      line-height: 1.15;
      word-break: break-word;
    }
    .dose .note{
      margin:0;
      font-size: 14px;
      color: var(--muted);
      line-height: 1.25;
    }

    /* ===== SEMANA ===== */
    .weekly{
      padding: 14px;
    }

    /* full-bleed para que SIEMPRE se vea completa en desktop */
    .weekly.full-bleed{
      width: 100vw;
      margin-left: calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
      padding-left: 22px;
      padding-right: 22px;
      padding-top: 14px;
      padding-bottom: 14px;
    }

    .table-wrap{
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
    }

    table.weekview{
      width: max-content;
      min-width: 1280px;  /* obliga a que existan 7 d√≠as completos */
      border-collapse:collapse;
    }

    .weekview th, .weekview td{
      border-bottom: 1px solid rgba(255,255,255,0.10);
      border-right: 1px solid rgba(255,255,255,0.08);
      padding: 12px 10px;
      vertical-align:top;
    }
    .weekview th:last-child, .weekview td:last-child{ border-right:none; }

    .weekview th{
      text-align:left;
      font-size: 14px;
      color: rgba(241,211,139,0.95);
      background: rgba(214,179,90,0.08);
      letter-spacing: .2px;
      white-space:nowrap;
    }

    .weekview th:not(.sticky-col),
    .weekview td:not(.sticky-col){
      min-width: 170px;
    }

    .weekview th.sticky-col,
    .weekview td.sticky-col{
      position: sticky;
      left: 0;
      z-index: 5;
      background: rgba(0,0,0,0.28);
      backdrop-filter: blur(6px);
      min-width: 160px;
    }

    .mini{
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .mrow{
      display:flex;
      gap: 8px;
      align-items:flex-start;
    }
    .wkmark{
      display:inline-block;
      min-width: 18px;
      text-align:center;
      font-weight: 900;
      color: var(--gold2);
      border: 1px solid rgba(214,179,90,0.22);
      border-radius: 6px;
      padding: 2px 6px;
      user-select:none;
    }
    .mtext{ line-height: 1.2; font-size: 14px; }

    /* resaltar la columna del d√≠a actual en desktop */
    .weekview th.is-today{
      outline: 2px solid rgba(214,179,90,0.35);
      outline-offset: -2px;
    }
    .weekview td.is-today{
      background: rgba(214,179,90,0.05);
    }

    /* ===== M√ìVIL: semana como tarjetas (sin tabla horizontal) ===== */
    .week-cards{ display:none; }

    @media (max-width: 820px){
      body{ padding: 14px; }
      .weekly.full-bleed{
        padding-left: 14px;
        padding-right: 14px;
      }
      .table-wrap{ display:none; }

      .week-cards{
        display:grid;
        grid-template-columns: 1fr;
        gap: 12px;
        margin-top: 12px;
      }
      .day-card{
        border: 1px solid rgba(255,255,255,0.10);
        border-radius: 16px;
        background: rgba(0,0,0,0.18);
        padding: 12px;
      }
      .day-card .dh{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255,255,255,0.10);
        margin-bottom: 10px;
      }
      .day-card .dh strong{
        font-size: 16px;
        letter-spacing: .2px;
      }
      .day-card .today-pill{
        font-size: 12px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(214,179,90,0.30);
        color: rgba(241,211,139,0.95);
        background: rgba(214,179,90,0.10);
        display:none;
      }
      .day-card.is-today .today-pill{ display:inline-block; }
      .day-card .sec{ margin-top: 10px; }
      .day-card .sec-title{
        font-weight: 850;
        color: rgba(241,211,139,0.95);
        margin-bottom: 8px;
        font-size: 14px;
      }
      .day-card .mrow{
        display:flex;
        gap:10px;
        align-items:flex-start;
        padding: 6px 0;
      }
      .day-card .mtext{ font-size: 14px; }
    }

    footer{
      margin-top: 4px;
      padding: 14px 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: rgba(199,202,211,0.95);
      font-size: 13px;
      border-top: 1px solid rgba(255,255,255,0.10);
      text-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
    footer .right{ display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
    .sep{ width:6px;height:6px;border-radius:999px; background: rgba(214,179,90,0.65); box-shadow: 0 0 0 4px rgba(214,179,90,0.10); }
    .gold{ color: rgba(241,211,139,0.95); }

    /* ===== IMPRESI√ìN (Carta) ===== */
    @page { size: letter; margin: 0.55in; }
    @media print{
      body{
        padding:0;
        background: #fff !important;
        color: #111 !important;
      }
      body::before, body::after{ display:none !important; }
      .page{ max-width: none; }
      header, .card, footer{
        box-shadow: none !important;
        backdrop-filter: none !important;
      }
      header, .card{
        border: 1px solid #ddd !important;
        background: #fff !important;
        color: #111 !important;
      }
      .pill, .badge{
        border: 1px solid #ccc !important;
        background: #f7f7f7 !important;
        color: #333 !important;
      }
      .badge.gold, .weekview th{
        color: #6a4b00 !important;
        background: #fff7e6 !important;
        border-color: #e7d3a6 !important;
      }
      .dose, .block, .table-wrap{
        border-color: #ddd !important;
        background: #fff !important;
      }
      .dose .note, footer{ color:#333 !important; }
      .actions{ display:none !important; }
      .weekly.full-bleed{ width:auto; margin:0; padding:0; }
      .week-cards{ display:none !important; }
      .table-wrap{ display:block !important; }
      table.weekview{ min-width: 0; width:100%; }
    }
  </style>
</head>

<body>
  <div class="page">

    <header>
      <div class="brand">
        <img src="./logo.png" alt="Logo" />
        <div class="t">
          <h1>Calendario de medicamentos</h1>
          <div class="pill">Impresi√≥n Carta ‚Ä¢ Marcar rutina (se guarda) ‚Ä¢ Semana = espejo de HOY</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn-gold" onclick="window.print()">üñ®Ô∏è Imprimir</button>
        <button class="btn-danger" onclick="clearAll()">üßº Limpiar marcas</button>
      </div>
    </header>

    <!-- RUTINA DIARIA -->
    <section class="card">
      <div class="card-head">
        <h2>üïí Rutina diaria</h2>
        <span class="badge gold" id="todayBadge">Hoy</span>
      </div>

      <div class="routine">

        <!-- MA√ëANA -->
        <div class="block">
          <div class="bh">
            <strong>üå§Ô∏è Ma√±ana</strong>
            <span>despu√©s / seg√∫n indique</span>
          </div>
          <div class="bl">

            <div class="dose">
              <input type="checkbox" data-key="amiodarona_am" />
              <div class="txt">
                <p class="name">Amiodarona (¬Ω tableta)</p>
                <p class="note">Ma√±ana</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="rivaroxaban_am" />
              <div class="txt">
                <p class="name">Rivaroxaban 15 mg (¬Ω tableta)</p>
                <p class="note">Ma√±ana</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="acido_folico_am" />
              <div class="txt">
                <p class="name">√Åcido f√≥lico</p>
                <p class="note">Ma√±ana</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="zyplo_am" />
              <div class="txt">
                <p class="name">Zyplo 10 ml</p>
                <p class="note">Cada 8 horas (primera dosis en la ma√±ana)</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="linezolid_am" />
              <div class="txt">
                <p class="name">Linezolid (1 tableta)</p>
                <p class="note">Cada 12 horas ‚Ä¢ despu√©s de las comidas</p>
              </div>
            </div>

          </div>
        </div>

        <!-- TARDE -->
        <div class="block">
          <div class="bh">
            <strong>üåá Tarde</strong>
            <span>horarios</span>
          </div>
          <div class="bl">

            <div class="dose">
              <input type="checkbox" data-key="omeprazol_pm" />
              <div class="txt">
                <p class="name">Omeprazol</p>
                <p class="note">Tarde</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="ziplo_5pm" />
              <div class="txt">
                <p class="name">Ziplo 10 ml</p>
                <p class="note">5:00 pm</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="inhalador_6pm" />
              <div class="txt">
                <p class="name">Inhalador</p>
                <p class="note">6:00 pm</p>
              </div>
            </div>

          </div>
        </div>

        <!-- NOCHE -->
        <div class="block">
          <div class="bh">
            <strong>üåô Noche</strong>
            <span>cierre del d√≠a</span>
          </div>
          <div class="bl">

            <div class="dose">
              <input type="checkbox" data-key="insulina_night" />
              <div class="txt">
                <p class="name">Insulina</p>
                <p class="note">Noche</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="sulfato_ferroso_night" />
              <div class="txt">
                <p class="name">Sulfato ferroso</p>
                <p class="note">Noche</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="zyplo_night" />
              <div class="txt">
                <p class="name">Zyplo</p>
                <p class="note">Noche (siguiente dosis cada 8h)</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="linezolid_night" />
              <div class="txt">
                <p class="name">Linezolid (1 tableta)</p>
                <p class="note">Despu√©s de cenar (cada 12h)</p>
              </div>
            </div>

            <div class="dose">
              <input type="checkbox" data-key="ertapenem_iv_night" />
              <div class="txt">
                <p class="name">Ertapenem IV</p>
                <p class="note">Noche</p>
              </div>
            </div>

            <!-- Eritropoyetina es semanal real (L-M-V). Esto s√≠ se guarda por d√≠a -->
            <div class="dose">
              <input type="checkbox" data-key="epo_mon" />
              <div class="txt">
                <p class="name">Eritropoyetina</p>
                <p class="note">Semana actual: marcar SOLO cuando aplique (L-M-V)</p>
              </div>
            </div>

          </div>
        </div>

      </div>
    </section>

    <!-- SEMANA (ESPEJO AUTOM√ÅTICO) -->
    <section class="card">
      <div class="card-head">
        <h2>üìÖ Semana (vista autom√°tica)</h2>
        <span class="badge">Marcas arriba ‚Üí aqu√≠ solo se refleja HOY ‚úÖ</span>
      </div>

      <div class="weekly full-bleed">

        <!-- DESKTOP / IMPRESI√ìN -->
        <div class="table-wrap">
          <table class="weekview" id="weekTable">
            <thead>
              <tr>
                <th class="sticky-col">Bloque</th>
                <th data-day="mon">Lunes</th>
                <th data-day="tue">Martes</th>
                <th data-day="wed">Mi√©rcoles</th>
                <th data-day="thu">Jueves</th>
                <th data-day="fri">Viernes</th>
                <th data-day="sat">S√°bado</th>
                <th data-day="sun">Domingo</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="sticky-col"><strong>Ma√±ana</strong><br><span style="color:var(--muted);font-size:13px;">Rutina</span></td>
                <td><div class="mini" data-day="mon" data-block="morning"></div></td>
                <td><div class="mini" data-day="tue" data-block="morning"></div></td>
                <td><div class="mini" data-day="wed" data-block="morning"></div></td>
                <td><div class="mini" data-day="thu" data-block="morning"></div></td>
                <td><div class="mini" data-day="fri" data-block="morning"></div></td>
                <td><div class="mini" data-day="sat" data-block="morning"></div></td>
                <td><div class="mini" data-day="sun" data-block="morning"></div></td>
              </tr>

              <tr>
                <td class="sticky-col"><strong>Tarde</strong><br><span style="color:var(--muted);font-size:13px;">Rutina</span></td>
                <td><div class="mini" data-day="mon" data-block="afternoon"></div></td>
                <td><div class="mini" data-day="tue" data-block="afternoon"></div></td>
                <td><div class="mini" data-day="wed" data-block="afternoon"></div></td>
                <td><div class="mini" data-day="thu" data-block="afternoon"></div></td>
                <td><div class="mini" data-day="fri" data-block="afternoon"></div></td>
                <td><div class="mini" data-day="sat" data-block="afternoon"></div></td>
                <td><div class="mini" data-day="sun" data-block="afternoon"></div></td>
              </tr>

              <tr>
                <td class="sticky-col"><strong>Noche</strong><br><span style="color:var(--muted);font-size:13px;">Rutina</span></td>
                <td><div class="mini" data-day="mon" data-block="night"></div></td>
                <td><div class="mini" data-day="tue" data-block="night"></div></td>
                <td><div class="mini" data-day="wed" data-block="night"></div></td>
                <td><div class="mini" data-day="thu" data-block="night"></div></td>
                <td><div class="mini" data-day="fri" data-block="night"></div></td>
                <td><div class="mini" data-day="sat" data-block="night"></div></td>
                <td><div class="mini" data-day="sun" data-block="night"></div></td>
              </tr>

              <!-- Eritropoyetina semanal real (L-M-V) -->
              <tr>
                <td class="sticky-col"><strong>Eritropoyetina</strong><br><span style="color:var(--muted);font-size:13px;">L-M-V</span></td>
                <td><div class="mrow"><span class="wkmark" data-key="epo_mon">‚òê</span><div class="mtext">Aplicada</div></div></td>
                <td><div class="mrow"><span class="wkmark">‚Äî</span><div class="mtext">No aplica</div></div></td>
                <td><div class="mrow"><span class="wkmark" data-key="epo_wed">‚òê</span><div class="mtext">Aplicada</div></div></td>
                <td><div class="mrow"><span class="wkmark">‚Äî</span><div class="mtext">No aplica</div></div></td>
                <td><div class="mrow"><span class="wkmark" data-key="epo_fri">‚òê</span><div class="mtext">Aplicada</div></div></td>
                <td><div class="mrow"><span class="wkmark">‚Äî</span><div class="mtext">No aplica</div></div></td>
                <td><div class="mrow"><span class="wkmark">‚Äî</span><div class="mtext">No aplica</div></div></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- M√ìVIL -->
        <div class="week-cards" id="weekCards"></div>

      </div>
    </section>

    <footer>
      <div>¬© <span id="year"></span> <span class="gold">Derechos reservados</span></div>
      <div class="right">
        <span class="sep"></span>
        <div>Powered by <strong class="gold">Cobian PC</strong></div>
      </div>
    </footer>
  </div>

  <script>
    // =========================
    // STORAGE + RESET LUNES (ISO)
    // =========================
    const STORAGE_KEY = "meds_calendar_letter_v2_iso";
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : { checked: {}, weekStamp: "" };
      }catch(_){
        return { checked: {}, weekStamp: "" };
      }
    }
    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    const state = loadState();

    // ISO week stamp: YYYY-Www (semana empieza lunes)
    function getISOWeekStamp(d=new Date()){
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      // ISO day: 1=Mon..7=Sun
      const day = date.getUTCDay() || 7;
      // mover a jueves de esta semana
      date.setUTCDate(date.getUTCDate() + 4 - day);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
      const yyyy = date.getUTCFullYear();
      const ww = String(weekNo).padStart(2,"0");
      return `${yyyy}-W${ww}`;
    }

    // si cambi√≥ la semana ISO ‚Üí limpia SOLO rutina diaria (no epo_*)
    function enforceWeeklyReset(){
      const stampNow = getISOWeekStamp();
      if(state.weekStamp && state.weekStamp === stampNow) return;

      // reset rutina diaria: todo lo que NO empiece con "epo_"
      const nextChecked = {};
      for(const [k,v] of Object.entries(state.checked || {})){
        if(k.startsWith("epo_")) nextChecked[k] = v;
      }
      state.checked = nextChecked;
      state.weekStamp = stampNow;
      saveState();
    }

    // =========================
    // MAPEOS (rutina diaria)
    // =========================
    const ROUTINE_MAP = {
      morning: [
        { key:"amiodarona_am",   label:"Amiodarona (¬Ω)" },
        { key:"rivaroxaban_am",  label:"Rivaroxaban 15mg (¬Ω)" },
        { key:"acido_folico_am", label:"√Åcido f√≥lico" },
        { key:"zyplo_am",        label:"Zyplo 10 ml (c/8h)" },
        { key:"linezolid_am",    label:"Linezolid (1) (c/12h)" }
      ],
      afternoon: [
        { key:"omeprazol_pm",    label:"Omeprazol" },
        { key:"ziplo_5pm",       label:"Ziplo 10 ml (5:00 pm)" },
        { key:"inhalador_6pm",   label:"Inhalador (6:00 pm)" }
      ],
      night: [
        { key:"insulina_night",          label:"Insulina" },
        { key:"sulfato_ferroso_night",   label:"Sulfato ferroso" },
        { key:"zyplo_night",             label:"Zyplo (c/8h)" },
        { key:"linezolid_night",         label:"Linezolid (1) despu√©s de cenar" },
        { key:"ertapenem_iv_night",      label:"Ertapenem IV" }
      ]
    };

    const DAY_LABELS = {
      mon:"Lunes", tue:"Martes", wed:"Mi√©rcoles", thu:"Jueves",
      fri:"Viernes", sat:"S√°bado", sun:"Domingo"
    };

    function getTodayDayKey(){
      // 0=Dom..6=S√°b  ‚Üí mon..sun
      const d = new Date();
      const map = ["sun","mon","tue","wed","thu","fri","sat"];
      return map[d.getDay()];
    }

    // =========================
    // BIND CHECKBOXES (arriba)
    // =========================
    function bindChecks(){
      document.querySelectorAll('input[type="checkbox"][data-key]').forEach(cb => {
        const k = cb.getAttribute("data-key");
        cb.checked = !!state.checked[k];

        cb.addEventListener("change", () => {
          state.checked[k] = cb.checked;
          saveState();
          renderWeekMirror(); // espejo inmediato
        });
      });
    }

    function clearAll(){
      if(!confirm("¬øSeguro que quieres limpiar todas las marcas?")) return;
      state.checked = {};
      saveState();
      document.querySelectorAll('input[type="checkbox"][data-key]').forEach(cb => cb.checked = false);
      renderWeekMirror();
    }
    window.clearAll = clearAll;

    // =========================
    // SEMANA: ESPEJO SOLO HOY
    // =========================
    function renderWeekMirror(){
      const today = getTodayDayKey();
      const days = ["mon","tue","wed","thu","fri","sat","sun"];

      // 1) Desktop tabla: llenar cada mini (d√≠a/bloque)
      document.querySelectorAll(".mini[data-day][data-block]").forEach(container => {
        const day = container.getAttribute("data-day");
        const block = container.getAttribute("data-block");
        const items = ROUTINE_MAP[block] || [];
        const isToday = (day === today);

        container.innerHTML = "";
        items.forEach(it => {
          const done = isToday ? !!state.checked[it.key] : false;
          const row = document.createElement("div");
          row.className = "mrow";
          row.innerHTML = `<span class="wkmark">${done ? "‚úÖ" : "‚òê"}</span><div class="mtext">${it.label}</div>`;
          container.appendChild(row);
        });
      });

      // 2) Eritropoyetina (epo_*) reflejo real por d√≠a
      document.querySelectorAll(".wkmark[data-key]").forEach(span => {
        const k = span.getAttribute("data-key");
        span.textContent = state.checked[k] ? "‚úÖ" : "‚òê";
      });

      // 3) Resaltar columna HOY en tabla
      const table = document.getElementById("weekTable");
      if(table){
        // limpia
        table.querySelectorAll("thead th").forEach(th => th.classList.remove("is-today"));
        table.querySelectorAll("tbody td").forEach(td => td.classList.remove("is-today"));

        const idx = days.indexOf(today); // 0..6
        if(idx >= 0){
          const col = idx + 2; // +1 por "Bloque"
          const thToday = table.querySelector(`thead th:nth-child(${col})`);
          if(thToday) thToday.classList.add("is-today");

          table.querySelectorAll("tbody tr").forEach(tr => {
            const td = tr.querySelector(`td:nth-child(${col})`);
            if(td) td.classList.add("is-today");
          });
        }
      }

      // 4) M√≥vil tarjetas
      renderWeekCards(today, days);
    }

    function renderWeekCards(today, days){
      const mount = document.getElementById("weekCards");
      if(!mount) return;

      mount.innerHTML = "";
      days.forEach(day => {
        const isToday = (day === today);

        const card = document.createElement("div");
        card.className = "day-card" + (isToday ? " is-today" : "");

        card.innerHTML = `
          <div class="dh">
            <strong>${DAY_LABELS[day]}</strong>
            <span class="today-pill">HOY</span>
          </div>

          <div class="sec">
            <div class="sec-title">Ma√±ana</div>
            <div class="mini" data-card-day="${day}" data-card-block="morning"></div>
          </div>

          <div class="sec">
            <div class="sec-title">Tarde</div>
            <div class="mini" data-card-day="${day}" data-card-block="afternoon"></div>
          </div>

          <div class="sec">
            <div class="sec-title">Noche</div>
            <div class="mini" data-card-day="${day}" data-card-block="night"></div>
          </div>
        `;

        mount.appendChild(card);
      });

      // llenar contenido (solo hoy ‚úÖ)
      document.querySelectorAll('.mini[data-card-day][data-card-block]').forEach(container => {
        const day = container.getAttribute("data-card-day");
        const block = container.getAttribute("data-card-block");
        const items = ROUTINE_MAP[block] || [];
        const isToday = (day === today);

        container.innerHTML = "";
        items.forEach(it => {
          const done = isToday ? !!state.checked[it.key] : false;
          const row = document.createElement("div");
          row.className = "mrow";
          row.innerHTML = `<span class="wkmark">${done ? "‚úÖ" : "‚òê"}</span><div class="mtext">${it.label}</div>`;
          container.appendChild(row);
        });
      });
    }

    // =========================
    // INIT
    // =========================
    enforceWeeklyReset();

    // footer + badge hoy
    document.getElementById("year").textContent = new Date().getFullYear();
    const todayName = DAY_LABELS[getTodayDayKey()] || "Hoy";
    document.getElementById("todayBadge").textContent = `Hoy: ${todayName} ‚Ä¢ ${getISOWeekStamp()}`;

    bindChecks();
    renderWeekMirror();
  </script>
</body>
</html>
